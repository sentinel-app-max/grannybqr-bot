<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#DC4040">
    <title>Granny B's Paint Advisor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #FFFFFF;
            height: 100vh;
            color: #1A1A1A;
        }

        /* ===== LEAD SCREEN ===== */
        .lead-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: #FFFFFF;
        }

        .lead-container {
            width: 100%;
            max-width: 420px;
            background: #FFFFFF;
            border-radius: 20px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .lead-header {
            background: linear-gradient(135deg, #DC4040 0%, #B83030 100%);
            padding: 30px 24px 24px;
            text-align: center;
        }

        .lead-header h1 {
            font-size: 22px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 4px;
        }

        .lead-header p {
            font-size: 13px;
            color: #FFFFFF;
            opacity: 0.8;
        }

        .lead-body {
            padding: 24px;
        }

        .incentive-text {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #7A9B6D;
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f7ed;
            border-radius: 10px;
        }

        .lead-body .form-group {
            margin-bottom: 16px;
        }

        .lead-body .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #1A1A1A;
            margin-bottom: 6px;
        }

        .lead-body .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e1e0d8;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            background: #FFFFFF;
            color: #1A1A1A;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .lead-body .form-group input:focus {
            outline: none;
            border-color: #DC4040;
            box-shadow: 0 0 0 3px rgba(220, 64, 64, 0.3);
        }

        .consent-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: #FFFFFF;
            border-radius: 10px;
        }

        .consent-group input[type="checkbox"] {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            accent-color: #DC4040;
        }

        .consent-group label {
            font-size: 12px;
            color: #8C8577;
            line-height: 1.4;
            cursor: pointer;
        }

        .lead-submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #DC4040 0%, #B83030 100%);
            color: #FFFFFF;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .lead-submit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(220, 64, 64, 0.4); }

        .skip-link {
            display: block;
            width: 100%;
            text-align: center;
            background: none;
            border: none;
            color: #8C8577;
            font-size: 13px;
            padding: 14px;
            cursor: pointer;
            text-decoration: underline;
        }

        .skip-link:hover { color: #1A1A1A; }

        .lead-footer, .chat-footer, .thanks-footer {
            text-align: center;
            font-size: 11px;
            color: #8C8577;
            padding: 16px;
            background: #FFFFFF;
        }

        /* ===== CHAT SCREEN ===== */
        .chat-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #FFFFFF;
        }

        .chat-header {
            background: #DC4040;
            color: #FFFFFF;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header-left-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .header-center {
            text-align: center;
            flex: 1;
            min-width: 0;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .chat-header .header-subtitle {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 2px;
        }

        .language-selector {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #FFFFFF;
            padding: 5px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            outline: none;
        }

        .language-selector option {
            background: #FFFFFF;
            color: #1A1A1A;
        }

        .done-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #FFFFFF;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .done-btn:hover { background: rgba(255, 255, 255, 0.3); }

        /* ===== PRODUCT BADGE ===== */
        .product-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: #FFF5F5;
            border-bottom: 2px solid #DC4040;
            flex-shrink: 0;
        }

        .colour-swatch {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #F7E07D;
            border: 2px solid #DC4040;
            flex-shrink: 0;
        }

        .product-badge span {
            font-size: 12px;
            font-weight: 600;
            color: #DC4040;
        }

        /* ===== VOICE STATUS ===== */
        .voice-status {
            font-size: 11px;
            color: #8C8577;
            text-align: center;
            padding: 4px;
            background: #f0efe8;
            display: none;
            flex-shrink: 0;
        }

        .voice-status.active { display: block; }

        /* ===== CHAT MESSAGES ===== */
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #FFFFFF;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            position: relative;
        }

        .user-message { justify-content: flex-end; }
        .user-message .message-content {
            background: #1A1A1A;
            color: #FFFFFF;
        }

        .bot-message { justify-content: flex-start; }
        .bot-message .message-content {
            background: #FFFFFF;
            color: #1A1A1A;
            border: 1px solid #F0E0E0;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        .message-content a { color: #DC4040; text-decoration: none; }
        .message-content a:hover { text-decoration: underline; }
        .user-message .message-content a { color: #FF8A8A; text-decoration: underline; }

        /* ===== SPEAK BUTTON ===== */
        .speak-btn {
            background: none;
            border: none;
            color: #B83030;
            cursor: pointer;
            font-size: 13px;
            padding: 4px 8px;
            margin-top: 6px;
            border-radius: 10px;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .speak-btn:hover { background: rgba(220, 64, 64, 0.15); }
        .speak-btn.loading { color: #8C8577; cursor: wait; }
        .speak-btn.playing { color: #e74c3c; }

        /* ===== GUIDED QUESTIONS ===== */
        .guided-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .guided-option {
            background: #FFFFFF;
            border: 1.5px solid #DC4040;
            color: #1A1A1A;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .guided-option:hover {
            border-color: #DC4040;
            background: #DC4040;
            color: #FFFFFF;
        }

        .guided-option:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .guided-option.selected {
            background: #DC4040;
            border-color: #DC4040;
            color: #FFFFFF;
            font-weight: 700;
            opacity: 1;
        }

        /* ===== PROMO CARDS ===== */
        .promo-card {
            margin: 10px 0;
            padding: 14px 16px;
            border-radius: 12px;
            border-left: 4px solid #ccc;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .promo-badge {
            font-size: 9px;
            font-weight: 800;
            letter-spacing: 1px;
            color: #1A1A1A;
            opacity: 0.5;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .promo-title {
            font-size: 14px;
            font-weight: 700;
            color: #1A1A1A;
            margin-bottom: 2px;
        }

        .promo-deal {
            font-size: 13px;
            font-weight: 600;
            color: #1A1A1A;
        }

        .promo-aisle {
            font-size: 11px;
            color: #8C8577;
            margin-top: 2px;
        }

        .promo-dismiss {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #8C8577;
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .promo-dismiss:hover { background: rgba(0,0,0,0.05); }

        /* ===== TYPING INDICATOR ===== */
        .typing-indicator {
            display: none;
            padding: 10px;
            margin: 10px 0;
        }

        .typing-indicator.active {
            display: flex;
            align-items: center;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: #B83030;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* ===== CHAT INPUT ===== */
        .chat-input {
            padding: 12px 16px;
            background: #FFFFFF;
            border-top: 1px solid #f0efe8;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e1e0d8;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
            font-family: inherit;
            background: #FFFFFF;
            color: #1A1A1A;
        }

        .chat-input input:focus {
            border-color: #DC4040;
            box-shadow: 0 0 0 2px rgba(220, 64, 64, 0.3);
        }

        .chat-input button {
            flex-shrink: 0;
            background: linear-gradient(135deg, #DC4040 0%, #B83030 100%);
            color: #FFFFFF;
            border: none;
            padding: 12px 18px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .chat-input button:hover { transform: translateY(-1px); }
        .chat-input button:disabled { opacity: 0.5; cursor: not-allowed; }

        .mic-btn {
            flex-shrink: 0;
            background: linear-gradient(135deg, #DC4040 0%, #B83030 100%);
            color: #FFFFFF;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn:hover { transform: translateY(-1px); }

        .mic-btn.recording {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        }

        /* ===== THANK YOU SCREEN ===== */
        .thanks-screen {
            display: none;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: #FFFFFF;
        }

        .thanks-container {
            width: 100%;
            max-width: 420px;
            text-align: center;
            padding: 40px 24px;
        }

        .thanks-container h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1A1A1A;
            margin-bottom: 8px;
        }

        .thanks-container > p {
            font-size: 14px;
            color: #8C8577;
            margin-bottom: 20px;
        }

        .discount-box {
            border: 2px dashed #DC4040;
            border-radius: 14px;
            padding: 20px;
            margin: 0 auto 12px;
            max-width: 280px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .discount-box:hover { background: rgba(220, 64, 64, 0.1); }

        .discount-box .code {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: 3px;
            color: #1A1A1A;
        }

        .discount-box .tap-hint {
            font-size: 11px;
            color: #8C8577;
            margin-top: 4px;
        }

        .discount-note {
            font-size: 13px;
            color: #7A9B6D;
            font-weight: 600;
            margin-bottom: 28px;
        }

        .cta-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 12px;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            text-decoration: none;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .cta-btn:hover { transform: translateY(-1px); }

        .cta-btn.primary {
            background: linear-gradient(135deg, #DC4040 0%, #B83030 100%);
            color: #FFFFFF;
        }

        .cta-btn.primary:hover { box-shadow: 0 4px 16px rgba(220, 64, 64, 0.4); }

        .cta-btn.secondary {
            background: #FFFFFF;
            color: #1A1A1A;
            border: 2px solid #e1e0d8;
        }

        .cta-btn.secondary:hover { border-color: #DC4040; }

        /* ===== LOGO ===== */
        .header-logo {
            height: 36px;
            width: auto;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .lead-header-inner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* ===== CANDY STRIPE OVERLAY ===== */
        .lead-screen,
        .lead-header,
        .thanks-screen {
            position: relative;
            overflow: hidden;
        }

        .lead-screen::before,
        .lead-header::before,
        .thanks-screen::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(90deg, #FFFFFF 0px, #FFFFFF 12px, #DC4040 12px, #DC4040 16px);
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
        }

        .lead-screen > *,
        .lead-header > *,
        .thanks-screen > * {
            position: relative;
            z-index: 1;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .chat-input { padding: 10px 8px; gap: 6px; }
            .chat-input input { padding: 10px 12px; font-size: 13px; min-width: 0; }
            .chat-input button { padding: 10px 14px; font-size: 13px; }
            .mic-btn { width: 38px; height: 38px; min-width: 38px; font-size: 15px; }
            .product-badge { padding: 8px 12px; }
            .product-badge span { font-size: 11px; }
            .colour-swatch { width: 24px; height: 24px; }
        }
    </style>
</head>
<body>

    <!-- ===== LEAD SCREEN ===== -->
    <div class="lead-screen" id="leadScreen">
        <div class="lead-container">
            <div class="lead-header">
                <div class="lead-header-inner">
                    <img src="/granny-b-logo.png" alt="Granny B's" class="header-logo" onclick="resetApp()">
                    <div>
                        <h1>Granny B's Paint Advisor</h1>
                        <p>Your in-store chalk paint expert</p>
                    </div>
                    <select class="language-selector" id="leadLanguageSelector" onchange="changeLanguage(this.value)">
                        <option value="en" selected>EN</option>
                        <option value="af">AF</option>
                    </select>
                </div>
            </div>
            <div class="lead-body">
                <div class="incentive-text">Plus 10% off your next Granny B's online order</div>

                <div class="form-group">
                    <label>First name</label>
                    <input type="text" id="leadNameInput" placeholder="First name" autocomplete="given-name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="leadEmailInput" placeholder="you@email.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label>Mobile</label>
                    <input type="tel" id="leadPhoneInput" placeholder="0821234567" autocomplete="tel">
                </div>

                <div class="consent-group">
                    <input type="checkbox" id="consentCheck">
                    <label for="consentCheck">I consent to Granny B's and Leroy Merlin storing my details for product advice and offers (POPIA)</label>
                </div>

                <button class="lead-submit-btn" onclick="submitLeadForm()">Get my paint advice &rarr;</button>
                <button class="skip-link" onclick="skipLead()">Skip, just let me browse</button>
            </div>
            <div class="lead-footer">Powered by SUMMITWEBCRAFT &times; Granny B's &times; Leroy Merlin</div>
        </div>
    </div>

    <!-- ===== CHAT SCREEN ===== -->
    <div class="chat-screen" id="chatScreen">
        <div class="chat-header">
            <div class="header-left-group">
                <img src="/granny-b-logo.png" alt="Granny B's" class="header-logo" onclick="resetApp()">
                <select class="language-selector" id="languageSelector" onchange="changeLanguage(this.value)">
                    <option value="en" selected>EN</option>
                    <option value="af">AF</option>
                </select>
            </div>
            <div class="header-center">
                <h2>Granny B's Paint Advisor</h2>
                <p class="header-subtitle">Your in-store chalk paint expert</p>
            </div>
            <button class="done-btn" onclick="showThankYou()">Done &#10003;</button>
        </div>

        <div class="product-badge">
            <div class="colour-swatch"></div>
            <span>Chalk Paint Granny B's Daisy 1L &middot; R259 &middot; SKU 81415711</span>
        </div>

        <div class="voice-status" id="voiceStatus">&#127908; Listening...</div>

        <div class="chat-messages" id="chatMessages">
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="chat-input" id="chatInputArea">
            <input type="text" id="messageInput" placeholder="Ask about Granny B's paint...">
            <button class="mic-btn" id="micBtn" onclick="toggleVoiceInput()" title="Voice input">&#127908;</button>
            <button onclick="sendMessage()" id="sendButton">Send</button>
        </div>

        <div class="chat-footer">Powered by SUMMITWEBCRAFT &times; Granny B's &times; Leroy Merlin</div>
    </div>

    <!-- ===== THANK YOU SCREEN ===== -->
    <div class="thanks-screen" id="thankYouScreen">
        <div class="thanks-container">
            <h1 id="thanksTitle">Thanks!</h1>
            <p>Here's your exclusive discount:</p>

            <div class="discount-box" onclick="copyCode()">
                <div class="code">GRANNYB10</div>
                <div class="tap-hint" id="copyHint">Tap to copy</div>
            </div>
            <p class="discount-note">10% off your next Granny B's online order</p>

            <a href="https://www.grannyb.co.za/collections/old-fashioned-paint" class="cta-btn primary" target="_blank" rel="noopener">Shop Granny B's Online &rarr;</a>
            <a href="https://www.grannyb.co.za/pages/rewards" class="cta-btn secondary" target="_blank" rel="noopener">Join Rewards Programme</a>

            <div class="thanks-footer">Powered by SUMMITWEBCRAFT &times; Granny B's &times; Leroy Merlin</div>
        </div>
    </div>

    <script>
        /* ===== STATE ===== */
        let isWaitingForResponse = false;
        let conversationHistory = [];
        let currentLanguage = 'en';
        let recognition = null;
        let isRecording = false;
        let currentAudio = null;
        let mediaRecorder = null;
        let audioChunks = [];

        let leadData = { name: '', email: '', phone: '' };
        let guidedStep = 0;
        let shownPromos = new Set();
        let promoQueue = [];
        let visiblePromoEl = null;
        let urlParams = { sku: '81415711', store: 'leroy-merlin' };

        const speechLanguageMap = {
            'en': 'en-ZA', 'af': 'af-ZA'
        };

        /* ===== UI TRANSLATIONS ===== */
        const uiStrings = {
            en: {
                headerTitle: "Granny B\u2019s Paint Advisor",
                headerSubtitle: "Your in-store chalk paint expert",
                doneBtn: "Done \u2713",
                inputPlaceholder: "Ask about Granny B\u2019s paint...",
                sendBtn: "Send",
                greetingName: "Hi {name}! I see you\u2019re checking out Granny B\u2019s Daisy chalk paint \u2014 lovely choice! Let me help you find exactly what you need for your project.",
                greetingAnon: "Hi there! I see you\u2019re checking out Granny B\u2019s Daisy chalk paint \u2014 lovely choice! Let me help you find exactly what you need.",
                leadTitle: "Granny B\u2019s Paint Advisor",
                leadSubtitle: "Your in-store chalk paint expert",
                leadIncentive: "Plus 10% off your next Granny B\u2019s online order",
                leadNameLabel: "First name",
                leadNamePlaceholder: "First name",
                leadEmailLabel: "Email",
                leadEmailPlaceholder: "you@email.com",
                leadPhoneLabel: "Mobile",
                leadPhonePlaceholder: "0821234567",
                leadConsent: "I consent to Granny B\u2019s and Leroy Merlin storing my details for product advice and offers (POPIA)",
                leadSubmit: "Get my paint advice \u2192",
                leadSkip: "Skip, just let me browse",
                thanksTitle: "Thanks!",
                thanksTitleName: "Thanks, {name}!",
                thanksSubtitle: "Here\u2019s your exclusive discount:",
                discountNote: "10% off your next Granny B\u2019s online order",
                ctaShop: "Shop Granny B\u2019s Online \u2192",
                ctaRewards: "Join Rewards Programme",
                tapToCopy: "Tap to copy",
                copied: "Copied!",
                alertName: "Please enter your first name",
                alertEmail: "Please enter a valid email",
                alertPhone: "Please enter a valid SA mobile number (e.g. 0821234567)",
                alertConsent: "Please accept the POPIA consent to continue"
            },
            af: {
                headerTitle: "Granny B\u2019s Verfadviseur",
                headerSubtitle: "Jou in-winkel krytverf kenner",
                doneBtn: "Klaar \u2713",
                inputPlaceholder: "Vra oor Granny B\u2019s verf...",
                sendBtn: "Stuur",
                greetingName: "Haai {name}! Ek sien jy kyk na hierdie Daisy krytverf \u2014 pragtige keuse! Laat ek jou help om presies te kry wat jy nodig het vir jou projek.",
                greetingAnon: "Haai daar! Ek sien jy kyk na hierdie Daisy krytverf \u2014 pragtige keuse! Laat ek jou help om presies te kry wat jy nodig het.",
                leadTitle: "Granny B\u2019s Verfadviseur",
                leadSubtitle: "Jou in-winkel krytverf kenner",
                leadIncentive: "Plus 10% afslag op jou volgende Granny B\u2019s aanlyn bestelling",
                leadNameLabel: "Voornaam",
                leadNamePlaceholder: "Voornaam",
                leadEmailLabel: "E-pos",
                leadEmailPlaceholder: "jy@epos.com",
                leadPhoneLabel: "Selfoon",
                leadPhonePlaceholder: "0821234567",
                leadConsent: "Ek stem in dat Granny B\u2019s en Leroy Merlin my besonderhede mag stoor vir produkadvies en aanbiedinge (POPIA)",
                leadSubmit: "Kry my verfadvies \u2192",
                leadSkip: "Slaan oor, laat ek net blaai",
                thanksTitle: "Dankie!",
                thanksTitleName: "Dankie, {name}!",
                thanksSubtitle: "Hier is jou eksklusiewe afslag:",
                discountNote: "10% afslag op jou volgende Granny B\u2019s aanlyn bestelling",
                ctaShop: "Koop Granny B\u2019s Aanlyn \u2192",
                ctaRewards: "Sluit aan by Beloningsprogram",
                tapToCopy: "Tik om te kopi\u00EBer",
                copied: "Gekopieer!",
                alertName: "Voer asseblief jou voornaam in",
                alertEmail: "Voer asseblief \u2019n geldige e-posadres in",
                alertPhone: "Voer asseblief \u2019n geldige SA selfoonnommer in (bv. 0821234567)",
                alertConsent: "Aanvaar asseblief die POPIA-toestemming om voort te gaan"
            }
        };

        /* ===== GUIDED QUESTIONS ===== */
        const guidedQuestionsData = {
            en: [
                {
                    question: "What are you painting today?",
                    options: ["Furniture", "Kitchen cabinets", "Home d\u00e9cor / crafts", "Walls / feature wall", "Upcycle / thrift flip", "Just browsing"]
                },
                {
                    question: "What surface will you be painting on?",
                    options: ["Wood", "Metal", "Ceramic / pottery", "Melamine / laminate", "Fabric", "Not sure yet"]
                },
                {
                    question: "Have you used chalk paint before?",
                    options: ["Nope, first time!", "Done a project or two", "Experienced chalker", "I'm a pro / reseller"]
                },
                {
                    question: "What look are you going for?",
                    options: ["Vintage / distressed", "Smooth & modern", "Rustic farmhouse", "Bold statement colour", "Not sure, advise me"]
                }
            ],
            af: [
                {
                    question: "Wat verf jy vandag?",
                    options: ["Meubels", "Kombuiskaste", "Huisversiering / kunsvlyt", "Mure / kenmuuur", "Hergebruik / opknap", "Kyk net rond"]
                },
                {
                    question: "Watter oppervlak gaan jy verf?",
                    options: ["Hout", "Metaal", "Keramiek / pottebakkery", "Melamine / laminaat", "Materiaal", "Nie seker nie"]
                },
                {
                    question: "Het jy al krytverf gebruik?",
                    options: ["Nee, eerste keer!", "Een of twee projekte gedoen", "Ervare krytverfer", "Ek is \u2019n pro / herverkoper"]
                },
                {
                    question: "Watter voorkoms soek jy?",
                    options: ["Vintage / verweer", "Glad & modern", "Rustiese plaashuis", "Vet stelling kleur", "Nie seker, adviseer my"]
                }
            ]
        };

        var guidedQuestions = guidedQuestionsData[currentLanguage];

        /* ===== PROMO CARDS DATA ===== */
        const promoCards = [
            { id: 'sandpaper', triggers: ['sand','prep','wood'], title: 'Sandpaper Multi-Pack', deal: 'Buy 3 for R99', aisle: 'Aisle 3', bg: '#FFF3E0', border: '#FF9800' },
            { id: 'brushes', triggers: ['brush','tool','roller'], title: 'Premium Brush Set', deal: 'Was R189 \u2192 R129', aisle: 'Aisle 4', bg: '#E3F2FD', border: '#2196F3' },
            { id: 'tape', triggers: ['edge','clean','line','tape'], title: 'Masking Tape 3-Pack', deal: 'Only R69', aisle: 'Aisle 5', bg: '#E8F5E9', border: '#4CAF50' },
            { id: 'dropcloth', triggers: ['floor','protect','mess'], title: 'Drop Cloth 4\u00d75m', deal: 'From R49', aisle: 'Aisle 3', bg: '#F3E5F5', border: '#9C27B0' },
            { id: 'sealer', triggers: ['seal','protect','kitchen','water','durable'], title: "Granny B's Armour Sealer 1L", deal: 'R289', aisle: 'Same shelf', bg: '#FFF8E1', border: '#FFC107' },
            { id: 'colours', triggers: ['colour','color','other','different','range'], title: '65+ Chalk Paint Colours', deal: 'From R79.90', aisle: 'Same shelf', bg: '#FCE4EC', border: '#E91E63' }
        ];

        /* ===== URL PARAMS ===== */
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('sku')) urlParams.sku = params.get('sku');
            if (params.get('store')) urlParams.store = params.get('store');
        }

        /* ===== SCREEN NAVIGATION ===== */
        function showScreen(id) {
            document.getElementById('leadScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('thankYouScreen').style.display = 'none';
            const el = document.getElementById(id);
            el.style.display = 'flex';
        }

        /* ===== LEAD FORM ===== */
        function submitLeadForm() {
            const name = document.getElementById('leadNameInput').value.trim();
            const email = document.getElementById('leadEmailInput').value.trim();
            const phone = document.getElementById('leadPhoneInput').value.trim();
            const consent = document.getElementById('consentCheck').checked;

            var s = uiStrings[currentLanguage];
            if (!name) { alert(s.alertName); return; }
            if (!email || !email.includes('@')) { alert(s.alertEmail); return; }
            if (phone && !/^(\+27|0)\d{9}$/.test(phone)) { alert(s.alertPhone); return; }
            if (!consent) { alert(s.alertConsent); return; }

            leadData = { name, email, phone };

            fetch('/lead', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name, email, phone,
                    consent: true,
                    sku: urlParams.sku,
                    store: urlParams.store
                })
            }).catch(function(err) { console.error('Lead submit error:', err); });

            enterChat();
        }

        function skipLead() {
            leadData = { name: '', email: '', phone: '' };
            enterChat();
        }

        /* ===== ENTER CHAT ===== */
        function enterChat() {
            showScreen('chatScreen');
            var s = uiStrings[currentLanguage];
            var greeting = leadData.name
                ? s.greetingName.replace('{name}', leadData.name)
                : s.greetingAnon;
            addBotMessage(greeting);
            setTimeout(function() { showGuidedQuestion(0); }, 800);
        }

        /* ===== GUIDED QUESTIONS ===== */
        function showGuidedQuestion(index) {
            if (index >= guidedQuestions.length) {
                guidedStep = guidedQuestions.length;
                return;
            }

            var q = guidedQuestions[index];
            var container = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');

            var msgDiv = document.createElement('div');
            msgDiv.className = 'message bot-message';

            var contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = q.question;

            var optionsDiv = document.createElement('div');
            optionsDiv.className = 'guided-options';
            optionsDiv.setAttribute('data-question', index);

            q.options.forEach(function(opt) {
                var btn = document.createElement('button');
                btn.className = 'guided-option';
                btn.textContent = opt;
                btn.onclick = function() { selectGuidedOption(index, opt, optionsDiv); };
                optionsDiv.appendChild(btn);
            });

            contentDiv.appendChild(optionsDiv);
            msgDiv.appendChild(contentDiv);
            container.insertBefore(msgDiv, typing);
            container.scrollTop = container.scrollHeight;
        }

        async function selectGuidedOption(questionIndex, optionText, optionsDiv) {
            if (isWaitingForResponse) return;

            var buttons = optionsDiv.querySelectorAll('.guided-option');
            buttons.forEach(function(btn) {
                btn.disabled = true;
                if (btn.textContent === optionText) btn.classList.add('selected');
            });

            addUserMessage(optionText);
            conversationHistory.push({ role: 'user', content: optionText });

            isWaitingForResponse = true;
            var typing = document.getElementById('typingIndicator');
            typing.classList.add('active');

            try {
                var response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: optionText,
                        history: conversationHistory.slice(0, -1),
                        language: currentLanguage,
                        sku: urlParams.sku,
                        store: urlParams.store
                    })
                });

                var data = await response.json();
                typing.classList.remove('active');

                addBotMessage(data.response);
                conversationHistory.push({ role: 'assistant', content: data.response });

                checkPromoTriggers(optionText);
                checkPromoTriggers(data.response);

                if (questionIndex === 1 && !shownPromos.has('sealer')) {
                    showPromoCard(promoCards.find(function(p) { return p.id === 'sealer'; }));
                }

                guidedStep = questionIndex + 1;
                setTimeout(function() { showGuidedQuestion(guidedStep); }, 600);

            } catch (error) {
                typing.classList.remove('active');
                addBotMessage("Oops, had a little hiccup. Let\u2019s keep going!");
                guidedStep = questionIndex + 1;
                setTimeout(function() { showGuidedQuestion(guidedStep); }, 600);
            } finally {
                isWaitingForResponse = false;
            }
        }

        /* ===== MESSAGES ===== */
        function addBotMessage(text) {
            var container = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');

            var msgDiv = document.createElement('div');
            msgDiv.className = 'message bot-message';

            var contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            var linkedContent = text
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/([a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,})/g, '<a href="mailto:$1">$1</a>')
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
            contentDiv.innerHTML = linkedContent;

            var speakBtn = document.createElement('button');
            speakBtn.className = 'speak-btn';
            speakBtn.textContent = '\uD83D\uDD0A Listen';
            speakBtn.onclick = function() { speakText(this, text); };
            contentDiv.appendChild(speakBtn);

            msgDiv.appendChild(contentDiv);
            container.insertBefore(msgDiv, typing);
            container.scrollTop = container.scrollHeight;
        }

        function addUserMessage(text) {
            var container = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');

            var msgDiv = document.createElement('div');
            msgDiv.className = 'message user-message';

            var contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;

            msgDiv.appendChild(contentDiv);
            container.insertBefore(msgDiv, typing);
            container.scrollTop = container.scrollHeight;
        }

        /* ===== PROMO CARDS ===== */
        function checkPromoTriggers(text) {
            var lower = text.toLowerCase();
            promoCards.forEach(function(card) {
                if (!shownPromos.has(card.id) && card.triggers.some(function(t) { return lower.includes(t); })) {
                    shownPromos.add(card.id);
                    if (visiblePromoEl) {
                        promoQueue.push(card);
                    } else {
                        displayPromoCard(card);
                    }
                }
            });
        }

        function showPromoCard(card) {
            if (!card || shownPromos.has(card.id)) return;
            shownPromos.add(card.id);
            if (visiblePromoEl) {
                promoQueue.push(card);
            } else {
                displayPromoCard(card);
            }
        }

        function displayPromoCard(card) {
            var container = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');

            var promoDiv = document.createElement('div');
            promoDiv.className = 'promo-card';
            promoDiv.style.background = card.bg;
            promoDiv.style.borderLeftColor = card.border;

            promoDiv.innerHTML =
                '<button class="promo-dismiss">\u2715</button>' +
                '<div class="promo-badge">LEROY MERLIN</div>' +
                '<div class="promo-title">' + card.title + '</div>' +
                '<div class="promo-deal">' + card.deal + '</div>' +
                '<div class="promo-aisle">' + card.aisle + '</div>';

            promoDiv.querySelector('.promo-dismiss').onclick = function() {
                promoDiv.remove();
                visiblePromoEl = null;
                if (promoQueue.length > 0) {
                    setTimeout(function() { displayPromoCard(promoQueue.shift()); }, 300);
                }
            };

            visiblePromoEl = promoDiv;
            container.insertBefore(promoDiv, typing);
            container.scrollTop = container.scrollHeight;
        }

        /* ===== SEND MESSAGE (free chat) ===== */
        async function sendMessage() {
            var input = document.getElementById('messageInput');
            var sendBtn = document.getElementById('sendButton');
            var message = input.value.trim();

            if (!message || isWaitingForResponse) return;

            isWaitingForResponse = true;
            sendBtn.disabled = true;

            addUserMessage(message);
            input.value = '';

            conversationHistory.push({ role: 'user', content: message });

            var typing = document.getElementById('typingIndicator');
            typing.classList.add('active');

            try {
                var response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(0, -1),
                        language: currentLanguage,
                        sku: urlParams.sku,
                        store: urlParams.store
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                var data = await response.json();
                typing.classList.remove('active');

                addBotMessage(data.response);
                conversationHistory.push({ role: 'assistant', content: data.response });

                checkPromoTriggers(message);
                checkPromoTriggers(data.response);

                if (guidedStep < guidedQuestions.length) {
                    setTimeout(function() { showGuidedQuestion(guidedStep); }, 600);
                }

                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }

            } catch (error) {
                console.error('Error:', error);
                typing.classList.remove('active');
                addBotMessage('Connection error. Please try again or ask a Leroy Merlin team member for help.');
                conversationHistory.pop();
            } finally {
                isWaitingForResponse = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        /* ===== THANK YOU ===== */
        function showThankYou() {
            var s = uiStrings[currentLanguage];
            var title = leadData.name
                ? s.thanksTitleName.replace('{name}', leadData.name)
                : s.thanksTitle;
            document.getElementById('thanksTitle').textContent = title;
            showScreen('thankYouScreen');
        }

        function copyCode() {
            var s = uiStrings[currentLanguage];
            if (navigator.clipboard) {
                navigator.clipboard.writeText('GRANNYB10').then(function() {
                    document.getElementById('copyHint').textContent = s.copied;
                    setTimeout(function() { document.getElementById('copyHint').textContent = s.tapToCopy; }, 2000);
                });
            } else {
                var ta = document.createElement('textarea');
                ta.value = 'GRANNYB10';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                document.getElementById('copyHint').textContent = s.copied;
                setTimeout(function() { document.getElementById('copyHint').textContent = s.tapToCopy; }, 2000);
            }
        }

        /* ===== RESET APP ===== */
        function resetApp() {
            conversationHistory = [];
            guidedStep = 0;
            shownPromos = new Set();
            promoQueue = [];
            visiblePromoEl = null;
            isWaitingForResponse = false;
            leadData = { name: '', email: '', phone: '' };

            var msgs = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');
            msgs.innerHTML = '';
            msgs.appendChild(typing);
            typing.classList.remove('active');

            document.getElementById('messageInput').value = '';
            document.getElementById('leadNameInput').value = '';
            document.getElementById('leadEmailInput').value = '';
            document.getElementById('leadPhoneInput').value = '';
            document.getElementById('consentCheck').checked = false;

            showScreen('leadScreen');
        }

        /* ===== LANGUAGE ===== */
        function changeLanguage(lang) {
            currentLanguage = lang;
            guidedQuestions = guidedQuestionsData[currentLanguage];

            document.getElementById('languageSelector').value = lang;
            document.getElementById('leadLanguageSelector').value = lang;

            applyLanguage();

            if (document.getElementById('chatScreen').style.display === 'flex') {
                conversationHistory = [];
                guidedStep = 0;
                shownPromos = new Set();
                promoQueue = [];
                visiblePromoEl = null;
                isWaitingForResponse = false;

                var msgs = document.getElementById('chatMessages');
                var typing = document.getElementById('typingIndicator');
                msgs.innerHTML = '';
                msgs.appendChild(typing);
                typing.classList.remove('active');
                document.getElementById('messageInput').value = '';

                var s = uiStrings[currentLanguage];
                var greeting = leadData.name
                    ? s.greetingName.replace('{name}', leadData.name)
                    : s.greetingAnon;
                addBotMessage(greeting);
                setTimeout(function() { showGuidedQuestion(0); }, 800);
            }
        }

        function applyLanguage() {
            var s = uiStrings[currentLanguage];

            document.querySelector('.chat-header h2').textContent = s.headerTitle;
            document.querySelector('.chat-header .header-subtitle').textContent = s.headerSubtitle;
            document.querySelector('.done-btn').innerHTML = s.doneBtn;
            document.getElementById('messageInput').placeholder = s.inputPlaceholder;
            document.getElementById('sendButton').textContent = s.sendBtn;

            document.querySelector('.lead-header h1').textContent = s.leadTitle;
            document.querySelector('.lead-header p').textContent = s.leadSubtitle;
            document.querySelector('.incentive-text').textContent = s.leadIncentive;
            var labels = document.querySelectorAll('.lead-body .form-group label');
            if (labels[0]) labels[0].textContent = s.leadNameLabel;
            if (labels[1]) labels[1].textContent = s.leadEmailLabel;
            if (labels[2]) labels[2].textContent = s.leadPhoneLabel;
            document.getElementById('leadNameInput').placeholder = s.leadNamePlaceholder;
            document.getElementById('leadEmailInput').placeholder = s.leadEmailPlaceholder;
            document.getElementById('leadPhoneInput').placeholder = s.leadPhonePlaceholder;
            document.querySelector('.consent-group label').textContent = s.leadConsent;
            document.querySelector('.lead-submit-btn').innerHTML = s.leadSubmit;
            document.querySelector('.skip-link').textContent = s.leadSkip;

            document.querySelector('.thanks-container > p').textContent = s.thanksSubtitle;
            document.querySelector('.discount-note').textContent = s.discountNote;
            var ctaBtns = document.querySelectorAll('.cta-btn');
            if (ctaBtns[0]) ctaBtns[0].innerHTML = s.ctaShop;
            if (ctaBtns[1]) ctaBtns[1].textContent = s.ctaRewards;
            document.getElementById('copyHint').textContent = s.tapToCopy;
        }

        /* ===== VOICE: SPEECH RECOGNITION ===== */
        function getSupportedMimeType() {
            var types = ['audio/mp4', 'audio/webm;codecs=opus', 'audio/webm', 'audio/ogg'];
            for (var i = 0; i < types.length; i++) {
                if (MediaRecorder.isTypeSupported(types[i])) return types[i];
            }
            return 'audio/mp4';
        }

        function initSpeechRecognition() {
            var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            if (!isIOS && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;

                recognition.onstart = function() {
                    isRecording = true;
                    document.getElementById('micBtn').classList.add('recording');
                    document.getElementById('voiceStatus').classList.add('active');
                    document.getElementById('voiceStatus').textContent = '\uD83C\uDFA4 Listening...';
                };

                recognition.onend = function() {
                    isRecording = false;
                    document.getElementById('micBtn').classList.remove('recording');
                    document.getElementById('voiceStatus').classList.remove('active');
                };

                recognition.onresult = function(event) {
                    var finalTranscript = '';
                    for (var i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    if (finalTranscript) {
                        document.getElementById('messageInput').value = finalTranscript;
                        sendMessage();
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isRecording = false;
                    document.getElementById('micBtn').classList.remove('recording');
                    document.getElementById('voiceStatus').classList.remove('active');
                };
            }
        }

        async function toggleVoiceInput() {
            if (recognition) {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.lang = speechLanguageMap[currentLanguage];
                    try { recognition.start(); }
                    catch (e) { await startWhisperRecording(); }
                }
                return;
            }
            if (isRecording) { stopWhisperRecording(); }
            else { await startWhisperRecording(); }
        }

        async function startWhisperRecording() {
            try {
                var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                var options = {};

                if (!isIOS) {
                    var mimeType = getSupportedMimeType();
                    if (mimeType) options = { mimeType: mimeType };
                }

                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async function() {
                    document.getElementById('micBtn').classList.remove('recording');
                    document.getElementById('voiceStatus').textContent = '\u23F3 Processing...';
                    stream.getTracks().forEach(function(track) { track.stop(); });

                    var recordedMimeType = mediaRecorder.mimeType || 'audio/mp4';
                    var audioBlob = new Blob(audioChunks, { type: recordedMimeType });

                    if (audioChunks.length === 0 || audioBlob.size < 100) {
                        alert('Recording failed. Please speak for at least 2 seconds and try again.');
                        document.getElementById('voiceStatus').classList.remove('active');
                        return;
                    }
                    await sendAudioToSTT(audioBlob, recordedMimeType);
                };

                mediaRecorder.start(500);
                window.recordingStartTime = Date.now();
                mediaRecorder.onerror = function(e) { alert('MediaRecorder ERROR: ' + e.error.name); };

                isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                document.getElementById('voiceStatus').classList.add('active');
                document.getElementById('voiceStatus').textContent = '\uD83C\uDFA4 Listening...';

            } catch (err) {
                console.error('Microphone error:', err);
                alert('Microphone error: ' + err.message);
            }
        }

        function stopWhisperRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
            }
        }

        async function sendAudioToSTT(audioBlob, mimeType) {
            try {
                var filename = 'recording.mp4';
                if (mimeType) {
                    if (mimeType.includes('webm')) filename = 'recording.webm';
                    else if (mimeType.includes('ogg')) filename = 'recording.ogg';
                    else if (mimeType.includes('wav')) filename = 'recording.wav';
                }

                var formData = new FormData();
                formData.append('audio_file', audioBlob, filename);

                var response;
                try {
                    response = await fetch('/stt', { method: 'POST', body: formData });
                } catch (fetchError) {
                    alert('Network error: ' + fetchError.message);
                    document.getElementById('voiceStatus').classList.remove('active');
                    return;
                }

                if (!response.ok) {
                    var errorText = await response.text();
                    alert('Server error ' + response.status + ': ' + errorText);
                    document.getElementById('voiceStatus').classList.remove('active');
                    return;
                }

                var data = await response.json();
                document.getElementById('voiceStatus').classList.remove('active');

                if (data.text && data.text.trim()) {
                    document.getElementById('messageInput').value = data.text;
                    sendMessage();
                } else if (data.error) {
                    alert('Voice error: ' + data.error);
                } else {
                    alert('No speech detected. Please try again.');
                }

            } catch (error) {
                console.error('STT Error:', error);
                document.getElementById('voiceStatus').classList.remove('active');
                alert('Voice processing failed: ' + error.message);
            }
        }

        /* ===== VOICE: TEXT-TO-SPEECH ===== */
        async function speakText(button, text) {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                button.classList.remove('playing');
                button.textContent = '\uD83D\uDD0A Listen';
                currentAudio = null;
                return;
            }

            button.classList.add('loading');
            button.textContent = '\u23F3 Loading...';

            try {
                var response = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text.replace(/\*\*/g, "").replace(/[\u{1F300}-\u{1F9FF}]/gu, "").replace(/[\u{2600}-\u{26FF}]/gu, ""),
                        language: currentLanguage
                    })
                });

                if (!response.ok) throw new Error('TTS request failed');

                var data = await response.json();
                if (data.error) throw new Error(data.error);

                var byteCharacters = atob(data.audio);
                var byteNumbers = new Array(byteCharacters.length);
                for (var i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                var byteArray = new Uint8Array(byteNumbers);
                var blob = new Blob([byteArray], { type: 'audio/mpeg' });
                var audioSrc = URL.createObjectURL(blob);
                currentAudio = new Audio(audioSrc);

                button.classList.remove('loading');
                button.classList.add('playing');
                button.textContent = '\u23F9\uFE0F Stop';

                currentAudio.onended = function() {
                    button.classList.remove('playing');
                    button.textContent = '\uD83D\uDD0A Listen';
                    currentAudio = null;
                };

                currentAudio.onerror = function() {
                    button.classList.remove('playing');
                    button.textContent = '\uD83D\uDD0A Listen';
                    currentAudio = null;
                };

                currentAudio.play();

            } catch (error) {
                console.error('TTS Error:', error);
                button.classList.remove('loading');
                button.textContent = '\uD83D\uDD0A Listen';
                fallbackBrowserTTS(text);
            }
        }

        function fallbackBrowserTTS(text) {
            if ('speechSynthesis' in window) {
                var utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = speechLanguageMap[currentLanguage];
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        /* ===== KEYBOARD ===== */
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && document.activeElement === document.getElementById('messageInput')) {
                e.preventDefault();
                sendMessage();
            }
        });

        /* ===== INIT ===== */
        parseUrlParams();
        initSpeechRecognition();
    </script>
</body>
</html>
