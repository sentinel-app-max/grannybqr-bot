<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#DD2222">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/pwa-icon-192.png">
    <title>Granny B's Paint Advisor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #FFFFFF;
            height: 100vh;
            color: #1A1A1A;
        }

        /* ===== LEAD SCREEN ===== */
        .lead-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: #FFFFFF;
        }

        .lead-container {
            width: 100%;
            max-width: 420px;
            background: #FFFFFF;
            border-radius: 20px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .lead-header {
            background: #DD2222;
            padding: 30px 24px 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .lead-header h1 {
            font-size: 22px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 4px;
        }

        .lead-header p {
            font-size: 13px;
            color: #FFFFFF;
            opacity: 0.8;
        }

        .lead-body {
            padding: 24px;
        }

        .incentive-text {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #7A9B6D;
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f7ed;
            border-radius: 10px;
        }

        .lead-body .form-group {
            margin-bottom: 16px;
        }

        .lead-body .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #1A1A1A;
            margin-bottom: 6px;
        }

        .lead-body .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e1e0d8;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            background: #FFFFFF;
            color: #1A1A1A;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .lead-body .form-group input:focus {
            outline: none;
            border-color: #DD2222;
            box-shadow: 0 0 0 3px rgba(221, 34, 34, 0.3);
        }

        .consent-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: #FFFFFF;
            border-radius: 10px;
        }

        .consent-group input[type="checkbox"] {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            accent-color: #DD2222;
        }

        .consent-group label {
            font-size: 12px;
            color: #8C8577;
            line-height: 1.4;
            cursor: pointer;
        }

        .lead-submit-btn {
            width: 100%;
            background: #DD2222;
            color: #FFFFFF;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .lead-submit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(221, 34, 34, 0.4); }

        .skip-link {
            display: block;
            width: 100%;
            text-align: center;
            background: none;
            border: none;
            color: #8C8577;
            font-size: 13px;
            padding: 14px;
            cursor: pointer;
            text-decoration: underline;
        }

        .skip-link:hover { color: #1A1A1A; }

        .lead-footer, .chat-footer, .thanks-footer {
            text-align: center;
            font-size: 11px;
            color: #8C8577;
            padding: 16px;
            background: #FFFFFF;
        }

        /* ===== CHAT SCREEN ===== */
        .chat-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #FFFFFF;
        }

        .chat-header {
            background: #DD2222;
            color: #FFFFFF;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .header-left-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .header-center {
            text-align: center;
            flex: 1;
            min-width: 0;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .header-right-group {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .done-btn {
            background: #DD2222;
            border: none;
            color: #FFFFFF;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            transition: background 0.2s;
            flex-shrink: 0;
            margin-left: auto;
        }

        .done-btn:hover { background: #BB1A1A; }

        .analytics-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 80px;
            padding: 0 16px;
            border: 1.5px solid rgba(255,255,255,0.5);
            border-radius: 14px;
            color: #FFFFFF;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            white-space: nowrap;
            transition: background 0.2s, border-color 0.2s;
        }

        .analytics-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: #FFFFFF;
        }

        .inline-recipe-btn {
            display: block;
            width: 100%;
            background: #DD2222;
            color: #FFFFFF;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
            font-family: inherit;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .inline-recipe-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(221, 34, 34, 0.4);
        }

        /* ===== PRODUCT BADGE ===== */
        .product-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #FFF5F5;
            border-bottom: 2px solid #DD2222;
            flex-shrink: 0;
        }

        .colour-swatch {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #F7E07D;
            border: 2px solid #DD2222;
            flex-shrink: 0;
        }

        .product-badge span {
            font-size: 12px;
            font-weight: 600;
            color: #DD2222;
        }

        /* ===== VOICE STATUS ===== */
        .voice-status {
            font-size: 11px;
            color: #8C8577;
            text-align: center;
            padding: 4px;
            background: #f0efe8;
            display: none;
            flex-shrink: 0;
        }

        .voice-status.active { display: block; }

        /* ===== CHAT MESSAGES ===== */
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #FFFFFF;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            position: relative;
        }

        .user-message { justify-content: flex-end; }
        .user-message .message-content {
            background: #1A1A1A;
            color: #FFFFFF;
        }

        .bot-message { justify-content: flex-start; }
        .bot-message .message-content {
            background: #FFFFFF;
            color: #1A1A1A;
            border: 1px solid #F0E0E0;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        .message-content a { color: #DD2222; text-decoration: none; }
        .message-content a:hover { text-decoration: underline; }
        .user-message .message-content a { color: #FF8A8A; text-decoration: underline; }

        /* ===== GUIDED QUESTIONS ===== */
        .guided-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .guided-option {
            background: #FFFFFF;
            border: 1.5px solid #DD2222;
            color: #1A1A1A;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .guided-option:hover {
            border-color: #DD2222;
            background: #DD2222;
            color: #FFFFFF;
        }

        .guided-option:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .guided-option.selected {
            background: #DD2222;
            border-color: #DD2222;
            color: #FFFFFF;
            font-weight: 700;
            opacity: 1;
        }

        /* ===== PROMO CARDS ===== */
        .promo-card {
            margin: 10px 0;
            padding: 14px 16px;
            border-radius: 12px;
            border-left: 4px solid #ccc;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .promo-badge {
            font-size: 9px;
            font-weight: 800;
            letter-spacing: 1px;
            color: #1A1A1A;
            opacity: 0.5;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .promo-title {
            font-size: 14px;
            font-weight: 700;
            color: #1A1A1A;
            margin-bottom: 2px;
        }

        .promo-deal {
            font-size: 13px;
            font-weight: 600;
            color: #1A1A1A;
        }

        .promo-aisle {
            font-size: 11px;
            color: #8C8577;
            margin-top: 2px;
        }

        .promo-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .promo-check {
            background: none;
            border: 2px solid #8C8577;
            color: #8C8577;
            cursor: pointer;
            font-size: 14px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            padding: 0;
            line-height: 1;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s, transform 0.1s;
        }

        .promo-check.checked {
            background: #4CAF50;
            border-color: #4CAF50;
            color: #FFFFFF;
        }

        .promo-dismiss {
            background: none;
            border: none;
            color: #8C8577;
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            padding: 0;
        }

        .promo-dismiss:hover { background: rgba(0,0,0,0.05); }

        /* ===== TYPING INDICATOR ===== */
        .typing-indicator {
            display: none;
            padding: 10px;
            margin: 10px 0;
        }

        .typing-indicator.active {
            display: flex;
            align-items: center;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: #DD2222;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* ===== CHAT INPUT ===== */
        .chat-input {
            padding: 12px 16px;
            background: #FFFFFF;
            border-top: 1px solid #f0efe8;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e1e0d8;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
            font-family: inherit;
            background: #FFFFFF;
            color: #1A1A1A;
        }

        .chat-input input:focus {
            border-color: #DD2222;
            box-shadow: 0 0 0 2px rgba(221, 34, 34, 0.3);
        }

        .chat-input button {
            flex-shrink: 0;
            background: #DD2222;
            color: #FFFFFF;
            border: none;
            padding: 12px 18px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .chat-input button:hover { transform: translateY(-1px); }
        .chat-input button:disabled { opacity: 0.5; cursor: not-allowed; }

        .mic-btn {
            flex-shrink: 0;
            background: #DD2222;
            color: #FFFFFF;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn:hover { transform: translateY(-1px); }

        .mic-btn.recording {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        }

        /* ===== THANK YOU SCREEN ===== */
        .thanks-screen {
            display: none;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: #FFFFFF;
        }

        .thanks-container {
            width: 100%;
            max-width: 420px;
            text-align: center;
            padding: 40px 24px;
        }

        .thanks-container h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1A1A1A;
            margin-bottom: 8px;
        }

        .thanks-container > p {
            font-size: 14px;
            color: #8C8577;
            margin-bottom: 20px;
        }

        .discount-box {
            border: 2px dashed #DD2222;
            border-radius: 14px;
            padding: 20px;
            margin: 0 auto 12px;
            max-width: 280px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .discount-box:hover { background: rgba(221, 34, 34, 0.1); }

        .discount-box .code {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: 3px;
            color: #1A1A1A;
        }

        .discount-box .tap-hint {
            font-size: 11px;
            color: #8C8577;
            margin-top: 4px;
        }

        .discount-note {
            font-size: 13px;
            color: #7A9B6D;
            font-weight: 600;
            margin-bottom: 28px;
        }

        .cta-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 12px;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            text-decoration: none;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .cta-btn:hover { transform: translateY(-1px); }

        .cta-btn.primary {
            background: #DD2222;
            color: #FFFFFF;
        }

        .cta-btn.primary:hover { box-shadow: 0 4px 16px rgba(221, 34, 34, 0.4); }

        .cta-btn.secondary {
            background: #FFFFFF;
            color: #1A1A1A;
            border: 2px solid #e1e0d8;
        }

        .cta-btn.secondary:hover { border-color: #DD2222; }

        .wa-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 12px;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            text-decoration: none;
            text-align: center;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: inherit;
        }

        .wa-btn:hover { transform: translateY(-1px); }

        .wa-btn.wa-plan {
            background: #25D366;
            color: #FFFFFF;
        }

        .wa-btn.wa-plan:hover { box-shadow: 0 4px 16px rgba(37, 211, 102, 0.4); }

        .email-share-btn {
            background: #FFFFFF;
            color: #DD2222;
            border: 2px solid #DD2222;
        }

        .email-share-btn:hover { box-shadow: 0 4px 16px rgba(221, 34, 34, 0.3); }

        .wa-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }

        .restart-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 12px;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            text-align: center;
            background: #FFFFFF;
            color: #DD2222;
            border: 2px solid #DD2222;
            cursor: pointer;
            font-family: inherit;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .restart-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(221, 34, 34, 0.3);
        }

        .wa-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
        }

        .email-confirm {
            font-size: 13px;
            color: #7A9B6D;
            margin-bottom: 16px;
            padding: 8px 12px;
            background: #f0f7ed;
            border-radius: 8px;
        }

        .recap-loading {
            font-size: 12px;
            color: #8C8577;
            margin-bottom: 8px;
        }

        /* ===== LOGOS ===== */
        .header-logo {
            height: 80px;
            width: auto;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .partner-logo {
            height: 80px;
            width: auto;
            cursor: pointer;
            flex-shrink: 0;
        }

        .lead-header-inner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* ===== SUNBURST OVERLAY ===== */
        .lead-screen,
        .lead-header,
        .thanks-screen {
            position: relative;
            overflow: hidden;
        }

        .lead-screen::before,
        .lead-header::before,
        .thanks-screen::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 200%; height: 200%;
            transform: translate(-50%, -50%);
            background: conic-gradient(#DD2222 0deg, #DD2222 10deg, #FFFFFF 10deg, #FFFFFF 20deg, #DD2222 20deg, #DD2222 30deg, #FFFFFF 30deg, #FFFFFF 40deg, #DD2222 40deg, #DD2222 50deg, #FFFFFF 50deg, #FFFFFF 60deg, #DD2222 60deg, #DD2222 70deg, #FFFFFF 70deg, #FFFFFF 80deg, #DD2222 80deg, #DD2222 90deg, #FFFFFF 90deg, #FFFFFF 100deg, #DD2222 100deg, #DD2222 110deg, #FFFFFF 110deg, #FFFFFF 120deg, #DD2222 120deg, #DD2222 130deg, #FFFFFF 130deg, #FFFFFF 140deg, #DD2222 140deg, #DD2222 150deg, #FFFFFF 150deg, #FFFFFF 160deg, #DD2222 160deg, #DD2222 170deg, #FFFFFF 170deg, #FFFFFF 180deg, #DD2222 180deg, #DD2222 190deg, #FFFFFF 190deg, #FFFFFF 200deg, #DD2222 200deg, #DD2222 210deg, #FFFFFF 210deg, #FFFFFF 220deg, #DD2222 220deg, #DD2222 230deg, #FFFFFF 230deg, #FFFFFF 240deg, #DD2222 240deg, #DD2222 250deg, #FFFFFF 250deg, #FFFFFF 260deg, #DD2222 260deg, #DD2222 270deg, #FFFFFF 270deg, #FFFFFF 280deg, #DD2222 280deg, #DD2222 290deg, #FFFFFF 290deg, #FFFFFF 300deg, #DD2222 300deg, #DD2222 310deg, #FFFFFF 310deg, #FFFFFF 320deg, #DD2222 320deg, #DD2222 330deg, #FFFFFF 330deg, #FFFFFF 340deg, #DD2222 340deg, #DD2222 350deg, #FFFFFF 350deg, #FFFFFF 360deg);
            opacity: 0.08;
            pointer-events: none;
            z-index: 0;
        }

        .lead-screen > *,
        .lead-header > *,
        .thanks-screen > * {
            position: relative;
            z-index: 1;
        }

        /* ===== HEADER TIN STEP-AND-REPEAT ===== */
        .lead-header::after,
        .chat-header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('/granny-b-tin.png');
            background-size: 60px;
            background-repeat: repeat;
            opacity: 0.08;
            pointer-events: none;
            z-index: 0;
        }

        .chat-header > * {
            position: relative;
            z-index: 1;
        }

        /* ===== CHAT SUNBURST + TIN WATERMARK ===== */
        .chat-messages::before {
            content: '';
            position: fixed;
            top: 50%; left: 50%;
            width: 200vw; height: 200vh;
            transform: translate(-50%, -50%);
            background: conic-gradient(#DD2222 0deg, #DD2222 10deg, #FFFFFF 10deg, #FFFFFF 20deg, #DD2222 20deg, #DD2222 30deg, #FFFFFF 30deg, #FFFFFF 40deg, #DD2222 40deg, #DD2222 50deg, #FFFFFF 50deg, #FFFFFF 60deg, #DD2222 60deg, #DD2222 70deg, #FFFFFF 70deg, #FFFFFF 80deg, #DD2222 80deg, #DD2222 90deg, #FFFFFF 90deg, #FFFFFF 100deg, #DD2222 100deg, #DD2222 110deg, #FFFFFF 110deg, #FFFFFF 120deg, #DD2222 120deg, #DD2222 130deg, #FFFFFF 130deg, #FFFFFF 140deg, #DD2222 140deg, #DD2222 150deg, #FFFFFF 150deg, #FFFFFF 160deg, #DD2222 160deg, #DD2222 170deg, #FFFFFF 170deg, #FFFFFF 180deg, #DD2222 180deg, #DD2222 190deg, #FFFFFF 190deg, #FFFFFF 200deg, #DD2222 200deg, #DD2222 210deg, #FFFFFF 210deg, #FFFFFF 220deg, #DD2222 220deg, #DD2222 230deg, #FFFFFF 230deg, #FFFFFF 240deg, #DD2222 240deg, #DD2222 250deg, #FFFFFF 250deg, #FFFFFF 260deg, #DD2222 260deg, #DD2222 270deg, #FFFFFF 270deg, #FFFFFF 280deg, #DD2222 280deg, #DD2222 290deg, #FFFFFF 290deg, #FFFFFF 300deg, #DD2222 300deg, #DD2222 310deg, #FFFFFF 310deg, #FFFFFF 320deg, #DD2222 320deg, #DD2222 330deg, #FFFFFF 330deg, #FFFFFF 340deg, #DD2222 340deg, #DD2222 350deg, #FFFFFF 350deg, #FFFFFF 360deg);
            opacity: 0.05;
            pointer-events: none;
            z-index: -1;
        }

        .chat-messages::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('/granny-b-tin.png');
            background-size: 120px;
            background-repeat: repeat;
            opacity: 0.04;
            pointer-events: none;
            z-index: -1;
        }

        /* ===== LEAD MASCOT VIDEO ===== */
        .lead-mascot {
            display: block;
            height: 150px;
            width: auto;
            margin: 0 auto 12px;
            border-radius: 12px;
        }

        /* ===== FLOATING MASCOT ===== */
        .floating-mascot {
            position: fixed;
            bottom: 80px;
            left: 16px;
            z-index: 1000;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #FFFFFF;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            overflow: hidden;
            cursor: pointer;
            animation: mascotFloat 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-mascot video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        @keyframes mascotFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* ===== BOT AVATAR ===== */
        .bot-message {
            gap: 8px;
            align-items: flex-start;
        }

        .bot-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            object-position: top;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .chat-input { padding: 10px 8px; gap: 6px; }
            .chat-input input { padding: 10px 12px; font-size: 13px; min-width: 0; }
            .chat-input button { padding: 10px 14px; font-size: 13px; }
            .mic-btn { width: 38px; height: 38px; min-width: 38px; font-size: 15px; }
            .product-badge { padding: 8px 12px; }
            .product-badge span { font-size: 11px; }
            .colour-swatch { width: 24px; height: 24px; }
        }
    </style>
</head>
<body>

    <!-- ===== LEAD SCREEN ===== -->
    <div class="lead-screen" id="leadScreen">
        <div class="lead-container">
            <div class="lead-header">
                <div class="lead-header-inner">
                    <img src="/granny-b-logo.svg" alt="Granny B's" class="header-logo" onclick="resetApp()">
                    <div>
                        <h1>Your Smart Granny B</h1>
                    </div>
                    <a href="https://www.leroymerlin.co.za" target="_blank" rel="noopener"><img src="/leroy-merlin-logo.svg" alt="Leroy Merlin" class="partner-logo"></a>
                </div>
            </div>
            <div class="lead-body">
                <video class="lead-mascot" autoplay loop muted playsinline>
                    <source src="/granny-b-animated.mp4" type="video/mp4">
                </video>
                <div class="incentive-text">Plus 10% off your next Granny B's online order</div>

                <div class="form-group">
                    <label>First name</label>
                    <input type="text" id="leadNameInput" placeholder="First name" autocomplete="given-name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="leadEmailInput" placeholder="you@email.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label>Mobile</label>
                    <input type="tel" id="leadPhoneInput" placeholder="0821234567" autocomplete="tel">
                </div>

                <div class="consent-group">
                    <input type="checkbox" id="consentCheck">
                    <label for="consentCheck">I consent to Granny B's and Leroy Merlin storing my details for product advice and offers (POPIA)</label>
                </div>

                <button class="lead-submit-btn" onclick="submitLeadForm()">Get my paint advice &rarr;</button>
                <button class="skip-link" onclick="skipLead()">Skip, just let me browse</button>
            </div>
            <div class="lead-footer">Powered by SUMMITWEBCRAFT &times; Granny B's &times; Leroy Merlin</div>
        </div>
    </div>

    <!-- ===== CHAT SCREEN ===== -->
    <div class="chat-screen" id="chatScreen">
        <div class="chat-header">
            <div class="header-left-group">
                <img src="/granny-b-logo.svg" alt="Granny B's" class="header-logo" onclick="resetApp()">
            </div>
            <div class="header-right-group">
                <a href="/analytics.html" class="analytics-btn">&#128202; Analytics</a>
                <a href="https://www.leroymerlin.co.za" target="_blank" rel="noopener"><img src="/leroy-merlin-logo.svg" alt="Leroy Merlin" class="partner-logo"></a>
            </div>
        </div>

        <div class="product-badge" id="productBadge">
            <div class="colour-swatch"></div>
            <span>Chalk Paint Granny B's Daisy 1L &middot; R259 &middot; SKU 81415711</span>
            <button class="done-btn" onclick="showThankYou()">Done &#10003;</button>
        </div>

        <div class="voice-status" id="voiceStatus">&#127908; Listening...</div>

        <div class="chat-messages" id="chatMessages">
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="chat-input" id="chatInputArea">
            <input type="text" id="messageInput" placeholder="Ask about Granny B's paint...">
            <button class="mic-btn" id="micBtn" onclick="toggleVoiceInput()" title="Voice input">&#127908;</button>
            <button onclick="sendMessage()" id="sendButton">Send</button>
        </div>

        <div class="chat-footer">Powered by SUMMITWEBCRAFT &times; Granny B's &times; Leroy Merlin</div>
    </div>

    <!-- ===== THANK YOU SCREEN ===== -->
    <div class="thanks-screen" id="thankYouScreen">
        <div class="thanks-container">
            <h1 id="thanksTitle">Thanks!</h1>

            <p class="email-confirm" id="emailConfirm" style="display:none;"></p>

            <p id="thanksSubtitle">Here's your exclusive discount:</p>

            <div class="discount-box" onclick="copyCode()">
                <div class="code">GRANNYB10</div>
                <div class="tap-hint" id="copyHint">Tap to copy</div>
            </div>
            <p class="discount-note">10% off your next Granny B's online order</p>

            <p class="recap-loading" id="recapLoading" style="display:none;">Cooking up Granny's Recipe...</p>
            <button class="wa-btn wa-plan" id="waplanBtn" onclick="sendWhatsAppPlan()" style="display:none;">
                <svg class="wa-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                <span id="waplanBtnText">Send Granny's Recipe via WhatsApp</span>
            </button>
            <button class="wa-btn email-share-btn" id="emailShareBtn" onclick="emailShareRecipe()" style="display:none;">
                <svg class="wa-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                <span id="emailShareBtnText">Email Granny's Recipe to a Friend</span>
            </button>

            <a href="https://www.grannyb.co.za/collections/old-fashioned-paint" class="cta-btn primary" target="_blank" rel="noopener">Shop Granny B's Online &rarr;</a>
            <a href="https://www.grannyb.co.za/pages/rewards" class="cta-btn secondary" target="_blank" rel="noopener">Join Rewards Programme</a>

            <button class="restart-btn" onclick="resetApp()">Start a New Consultation &rarr;</button>

            <div class="thanks-footer">Powered by SUMMITWEBCRAFT &times; Granny B's &times; Leroy Merlin</div>
        </div>
    </div>

    <!-- ===== FLOATING MASCOT ===== -->
    <div class="floating-mascot" id="floatingMascot" onclick="triggerPaintTip()" style="display: none;">
        <video autoplay loop muted playsinline>
            <source src="/granny-b-animated.mp4" type="video/mp4">
        </video>
    </div>

    <script>
        /* ===== STATE ===== */
        let isWaitingForResponse = false;
        let conversationHistory = [];
        let currentLanguage = 'en';
        let recognition = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];

        let leadData = { name: '', email: '', phone: '' };
        let guidedStep = 0;
        let shownPromos = new Set();
        let promoQueue = [];
        let visiblePromoEl = null;
        let urlParams = { sku: '', store: 'leroy-merlin' };
        let flowMode = 'consultation';
        let consultAnswers = [];
        let recapData = null;
        let shoppingList = [];

        const speechLanguageMap = {
            'en': 'en-ZA'
        };

        /* ===== UI TRANSLATIONS ===== */
        const uiStrings = {
            en: {
                headerTitle: "Your Smart Granny B",
                doneBtn: "Done \u2713",
                inputPlaceholder: "Ask about Granny B\u2019s paint...",
                sendBtn: "Send",
                greetingName: "Hi {name}! I see you\u2019re checking out Granny B\u2019s Daisy chalk paint \u2014 lovely choice! Let me help you find exactly what you need for your project.",
                greetingAnon: "Hi there! I see you\u2019re checking out Granny B\u2019s Daisy chalk paint \u2014 lovely choice! Let me help you find exactly what you need.",
                consultGreetingName: "Welcome to Granny B\u2019s, {name}! I\u2019m your personal paint advisor. Tell me about your project and I\u2019ll help you find exactly what you need, from the right colour to the perfect finish.",
                consultGreetingAnon: "Welcome to Granny B\u2019s! I\u2019m your personal paint advisor. Tell me about your project and I\u2019ll help you find exactly what you need, from the right colour to the perfect finish.",
                leadTitle: "Your Smart Granny B",
                leadIncentive: "Plus 10% off your next Granny B\u2019s online order",
                leadNameLabel: "First name",
                leadNamePlaceholder: "First name",
                leadEmailLabel: "Email",
                leadEmailPlaceholder: "you@email.com",
                leadPhoneLabel: "Mobile",
                leadPhonePlaceholder: "0821234567",
                leadConsent: "I consent to Granny B\u2019s and Leroy Merlin storing my details for product advice and offers (POPIA)",
                leadSubmit: "Get my paint advice \u2192",
                leadSkip: "Skip, just let me browse",
                thanksTitle: "Thanks!",
                thanksTitleName: "Thanks, {name}!",
                thanksSubtitle: "Here\u2019s your exclusive discount:",
                discountNote: "10% off your next Granny B\u2019s online order",
                ctaShop: "Shop Granny B\u2019s Online \u2192",
                ctaRewards: "Join Rewards Programme",
                tapToCopy: "Tap to copy",
                copied: "Copied!",
                alertName: "Please enter your first name",
                alertEmail: "Please enter a valid email",
                alertPhone: "Please enter a valid SA mobile number (e.g. 0821234567)",
                alertConsent: "Please accept the POPIA consent to continue",
                recipeReadyMsg: "Your recipe is ready! Tap below to get it via email and WhatsApp.",
                getRecipeInline: "Get Granny\u2019s Recipe \uD83C\uDFA8",
                recapLoading: "Cooking up Granny\u2019s Recipe...",
                emailConfirm: "We\u2019ve emailed Granny\u2019s Recipe to {email}",
                waPlanBtn: "Send Granny\u2019s Recipe via WhatsApp",
                emailShareBtn: "Email Granny\u2019s Recipe to a Friend",
                emailShareSubject: "Check out this paint plan from Granny B\u2019s!",
                emailShareIntro: "Hey!\n\nI just got a personalised chalk paint recipe from Granny B\u2019s at Leroy Merlin. Check it out:\n\n",
                waHeader: "\uD83C\uDFA8 *Granny\u2019s Recipe*\nYour personal chalk paint plan\n",
                waProject: "Project",
                waSurface: "Surface",
                waLook: "Look",
                waColour: "Recommended Colour",
                waSealer: "Sealer",
                waPrep: "PREP",
                waPaint: "PAINT",
                waSeal: "SEAL",
                waLeroyProducts: "Leroy Merlin Products",
                waDiscount: "Discount Code: GRANNYB10 (10% off at grannyb.co.za)",
                emailShareTryIt: "Try the free paint advisor here: "
            }
        };

        /* ===== GUIDED QUESTIONS ===== */
        const guidedQuestionsData = {
            en: [
                {
                    question: "What are you painting today?",
                    options: ["Furniture", "Kitchen cabinets", "Home d\u00e9cor / crafts", "Walls / feature wall", "Upcycle / thrift flip", "Just browsing"]
                },
                {
                    question: "What surface will you be painting on?",
                    options: ["Wood", "Metal", "Ceramic / pottery", "Melamine / laminate", "Fabric", "Not sure yet"]
                },
                {
                    question: "Have you used chalk paint before?",
                    options: ["Nope, first time!", "Done a project or two", "Experienced chalker", "I'm a pro / reseller"]
                },
                {
                    question: "What look are you going for?",
                    options: ["Vintage / distressed", "Smooth & modern", "Rustic farmhouse", "Bold statement colour", "Not sure, advise me"]
                }
            ]
        };

        var guidedQuestions = guidedQuestionsData.en;

        /* ===== CONSULTATION GUIDED QUESTIONS (5 questions, Q2 conditional) ===== */
        const consultGuidedData = {
            en: [
                {
                    question: "What brings you here today?",
                    options: ["Furniture project", "Kitchen cabinets", "Upcycle / thrift flip", "Wall or feature wall", "Arts, crafts & d\u00e9cor", "Just browsing for inspiration"]
                },
                {
                    conditional: true,
                    variants: {
                        "Furniture project": { question: "What piece are you working on?", options: ["Dresser / chest", "Dining table", "Side table / nightstand", "Bookshelf / display", "Bed frame / headboard", "Other furniture"] },
                        "Kitchen cabinets": { question: "What specifically?", options: ["Cabinet doors", "Countertops", "Open shelving", "Kitchen island", "Full kitchen redo"] },
                        "Upcycle / thrift flip": { question: "What did you find?", options: ["Old chair", "Picture frame / mirror", "Wooden box or crate", "Side table or stool", "Thrift store find", "Something else"] },
                        "Wall or feature wall": { question: "What kind of wall?", options: ["Bedroom accent wall", "Living room feature", "Kids room", "Bathroom wall", "Outdoor wall"] },
                        "Arts, crafts & d\u00e9cor": { question: "What are you making?", options: ["Pots or vases", "Canvas or board art", "Home d\u00e9cor accessories", "Stencil project", "Gift or keepsake"] },
                        "Just browsing for inspiration": { question: "What caught your eye?", options: ["The colours", "Chalk paint technique", "Furniture makeovers", "Someone recommended it", "Just curious"] }
                    }
                },
                {
                    question: "What surface are we working with?",
                    options: ["Bare wood", "Stained or varnished wood", "Melamine / laminate", "Metal", "Ceramic / tiles / glass", "Not sure"]
                },
                {
                    question: "What\u2019s the dream?",
                    options: ["Vintage distressed charm", "Clean modern finish", "Rustic farmhouse", "Bold colour pop", "Soft neutral tones", "Show me what\u2019s trending"]
                },
                {
                    question: "And your experience with chalk paint?",
                    options: ["Total beginner", "Done a project or two", "Experienced painter", "Basically a pro"]
                }
            ]
        };

        /* ===== PROMO CARDS DATA ===== */
        /* Paired cards: each trigger group has a Dexter (value) and premium (brand) card.
           checkPromoTriggers alternates: first match shows Dexter, second shows premium via queue. */
        const promoCards = [
            { id: 'brushes-dexter', group: 'brushes', triggers: ['brush','paintbrush'], title: 'Dexter Paint Brush Set (3-pack)', deal: 'R89', aisle: 'Aisle 4', brand: 'Dexter', bg: '#E3F2FD', border: '#2196F3' },
            { id: 'brushes-dulux', group: 'brushes', triggers: ['brush','paintbrush'], title: 'Dulux Precision Brush Set (3-pack)', deal: 'R149', aisle: 'Aisle 4', brand: 'Dulux', bg: '#E3F2FD', border: '#1565C0' },
            { id: 'sandpaper-dexter', group: 'sandpaper', triggers: ['sand','prep','abrasive'], title: 'Dexter Sandpaper Assorted Pack', deal: 'R59', aisle: 'Aisle 3', brand: 'Dexter', bg: '#FFF3E0', border: '#FF9800' },
            { id: 'sandpaper-3m', group: 'sandpaper', triggers: ['sand','prep','abrasive'], title: '3M Sandpaper Assorted 10-pack', deal: 'R79', aisle: 'Aisle 3', brand: '3M', bg: '#FFF3E0', border: '#CC6600' },
            { id: 'tape-dexter', group: 'tape', triggers: ['tape','masking','edge'], title: 'Dexter Masking Tape 48mm', deal: 'R39', aisle: 'Aisle 5', brand: 'Dexter', bg: '#E8F5E9', border: '#4CAF50' },
            { id: 'tape-3m', group: 'tape', triggers: ['tape','masking','edge'], title: '3M ScotchBlue Painter\'s Tape 48mm', deal: 'R89', aisle: 'Aisle 5', brand: '3M', bg: '#E8F5E9', border: '#1B5E20' },
            { id: 'roller-dexter', group: 'roller', triggers: ['roller','foam roll','smooth'], title: 'Dexter Paint Roller Set', deal: 'R69', aisle: 'Aisle 4', brand: 'Dexter', bg: '#E0F7FA', border: '#00BCD4' },
            { id: 'roller-plascon', group: 'roller', triggers: ['roller','foam roll','smooth'], title: 'Plascon Double Velvet Roller 200mm', deal: 'R59', aisle: 'Aisle 4', brand: 'Plascon', bg: '#E0F7FA', border: '#006064' },
            { id: 'dropcloth', group: 'dropcloth', triggers: ['floor','mess','drop cloth','drop sheet','splatter'], title: 'Dexter Drop Sheet 4\u00d75m', deal: 'R35', aisle: 'Aisle 3', brand: 'Dexter', bg: '#F3E5F5', border: '#9C27B0' },
            { id: 'sugarsoap', group: 'sugarsoap', triggers: ['clean','sugar soap','wash'], title: 'Dulux Prep & Clean Sugar Soap 1L', deal: 'R49', aisle: 'Aisle 3', brand: 'Dulux', bg: '#FFF8E1', border: '#F9A825' },
            { id: 'sealer', group: 'sealer', triggers: ['seal','protect','kitchen','water','durable'], title: "Granny B's Armour Sealer 1L", deal: 'R289', aisle: 'Same shelf', brand: "Granny B's", bg: '#FFF8E1', border: '#FFC107' },
            { id: 'colours', group: 'colours', triggers: ['colour','color','other','different','range'], title: '65+ Chalk Paint Colours', deal: 'From R79.90', aisle: 'Same shelf', brand: "Granny B's", bg: '#FCE4EC', border: '#E91E63' }
        ];

        /* ===== URL PARAMS ===== */
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('sku')) {
                urlParams.sku = params.get('sku');
                flowMode = 'product';
            }
            if (params.get('store')) urlParams.store = params.get('store');
        }

        /* ===== SCREEN NAVIGATION ===== */
        function showScreen(id) {
            document.getElementById('leadScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('thankYouScreen').style.display = 'none';
            const el = document.getElementById(id);
            el.style.display = 'flex';

            var mascot = document.getElementById('floatingMascot');
            mascot.style.display = (id === 'leadScreen') ? 'none' : 'flex';
        }

        /* ===== LEAD FORM ===== */
        function submitLeadForm() {
            const name = document.getElementById('leadNameInput').value.trim();
            const email = document.getElementById('leadEmailInput').value.trim();
            const phone = document.getElementById('leadPhoneInput').value.trim();
            const consent = document.getElementById('consentCheck').checked;

            var s = uiStrings[currentLanguage];
            if (!name) { alert(s.alertName); return; }
            if (!email || !email.includes('@')) { alert(s.alertEmail); return; }
            if (phone && !/^(\+27|0)\d{9}$/.test(phone)) { alert(s.alertPhone); return; }
            if (!consent) { alert(s.alertConsent); return; }

            leadData = { name, email, phone };
            GBAnalytics.leadSubmit(name, email);

            fetch('/lead', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name, email, phone,
                    consent: true,
                    sku: urlParams.sku,
                    store: urlParams.store
                })
            }).catch(function(err) { console.error('Lead submit error:', err); });

            enterChat();
        }

        function skipLead() {
            leadData = { name: '', email: '', phone: '' };
            enterChat();
        }

        /* ===== ENTER CHAT ===== */
        function enterChat() {
            showScreen('chatScreen');
            var s = uiStrings[currentLanguage];
            var greeting;

            if (flowMode === 'product') {
                document.getElementById('productBadge').style.display = 'flex';
                greeting = leadData.name
                    ? s.greetingName.replace('{name}', leadData.name)
                    : s.greetingAnon;
            } else {
                document.getElementById('productBadge').style.display = 'none';
                consultAnswers = [];
                greeting = leadData.name
                    ? s.consultGreetingName.replace('{name}', leadData.name)
                    : s.consultGreetingAnon;
            }

            addBotMessage(greeting);
            setTimeout(function() { showGuidedQuestion(0); }, 800);
        }

        /* ===== GUIDED QUESTION HELPERS ===== */
        function getCurrentGuidedQuestion(index) {
            if (flowMode === 'product') {
                return guidedQuestions[index] || null;
            }
            var questions = consultGuidedData.en;
            if (index >= questions.length) return null;
            var q = questions[index];
            if (q.conditional) {
                var prevAnswer = consultAnswers[0];
                return q.variants[prevAnswer] || null;
            }
            return q;
        }

        function getGuidedQuestionsLength() {
            if (flowMode === 'product') return guidedQuestions.length;
            return consultGuidedData.en.length;
        }

        function activateRecipeButton() {
            var s = uiStrings[currentLanguage];

            var container = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');

            var msgDiv = document.createElement('div');
            msgDiv.className = 'message bot-message';

            var avatar = document.createElement('img');
            avatar.className = 'bot-avatar';
            avatar.src = '/granny-b-logo.png';
            avatar.alt = '';
            msgDiv.appendChild(avatar);

            var contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = s.recipeReadyMsg;

            var recipeBtn = document.createElement('button');
            recipeBtn.className = 'inline-recipe-btn';
            recipeBtn.textContent = s.getRecipeInline;
            recipeBtn.onclick = function() { GBAnalytics.recipeTap(); showThankYou(); };
            contentDiv.appendChild(recipeBtn);

            msgDiv.appendChild(contentDiv);
            container.insertBefore(msgDiv, typing);
            container.scrollTop = container.scrollHeight;
        }

        /* ===== GUIDED QUESTIONS ===== */
        function showGuidedQuestion(index) {
            var q = getCurrentGuidedQuestion(index);
            if (!q) {
                guidedStep = getGuidedQuestionsLength();
                return;
            }
            var container = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');

            var msgDiv = document.createElement('div');
            msgDiv.className = 'message bot-message';

            var contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = q.question;

            var optionsDiv = document.createElement('div');
            optionsDiv.className = 'guided-options';
            optionsDiv.setAttribute('data-question', index);

            q.options.forEach(function(opt) {
                var btn = document.createElement('button');
                btn.className = 'guided-option';
                btn.textContent = opt;
                btn.onclick = function() { selectGuidedOption(index, opt, optionsDiv); };
                optionsDiv.appendChild(btn);
            });

            contentDiv.appendChild(optionsDiv);
            msgDiv.appendChild(contentDiv);
            container.insertBefore(msgDiv, typing);
            container.scrollTop = container.scrollHeight;
        }

        async function selectGuidedOption(questionIndex, optionText, optionsDiv) {
            if (isWaitingForResponse) return;

            var buttons = optionsDiv.querySelectorAll('.guided-option');
            buttons.forEach(function(btn) {
                btn.disabled = true;
                if (btn.textContent === optionText) btn.classList.add('selected');
            });

            if (flowMode === 'consultation') {
                consultAnswers.push(optionText);
            }

            addUserMessage(optionText);
            conversationHistory.push({ role: 'user', content: optionText });
            GBAnalytics.guidedAnswer(getCurrentGuidedQuestion(questionIndex).question, optionText);

            isWaitingForResponse = true;
            var typing = document.getElementById('typingIndicator');
            typing.classList.add('active');

            try {
                var response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: optionText,
                        history: conversationHistory.slice(0, -1),
                        language: currentLanguage,
                        sku: urlParams.sku,
                        store: urlParams.store,
                        flow: flowMode
                    })
                });

                var data = await response.json();
                typing.classList.remove('active');

                addBotMessage(data.response);
                conversationHistory.push({ role: 'assistant', content: data.response });

                checkPromoTriggers(optionText);
                checkPromoTriggers(data.response);

                if (flowMode === 'product') {
                    if (questionIndex === 1 && !shownPromos.has('sealer')) {
                        showPromoCard(promoCards.find(function(p) { return p.id === 'sealer'; }));
                    }
                } else {
                    var lowerOpt = optionText.toLowerCase();
                    if (questionIndex === 2) {
                        if (lowerOpt.includes('wood') || lowerOpt.includes('hout')) {
                            showPromoGroupCards('sandpaper');
                        }
                        if (lowerOpt.includes('kitchen') || lowerOpt.includes('tile') || lowerOpt.includes('kombuis') || lowerOpt.includes('te\u00ebl') || lowerOpt.includes('ceramic') || lowerOpt.includes('keramiek')) {
                            showPromoCard(promoCards.find(function(p) { return p.id === 'sealer'; }));
                        }
                    }
                    if (questionIndex === 3) {
                        if (lowerOpt.includes('vintage') || lowerOpt.includes('distress') || lowerOpt.includes('verweer')) {
                            showPromoGroupCards('sandpaper');
                        }
                    }
                    if (questionIndex === 4) {
                        showPromoGroupCards('brushes');
                    }
                }

                guidedStep = questionIndex + 1;
                if (guidedStep >= getGuidedQuestionsLength()) {
                    setTimeout(function() { activateRecipeButton(); }, 800);
                } else {
                    setTimeout(function() { showGuidedQuestion(guidedStep); }, 600);
                }

            } catch (error) {
                typing.classList.remove('active');
                addBotMessage("Oops, had a little hiccup. Let\u2019s keep going!");
                guidedStep = questionIndex + 1;
                if (guidedStep >= getGuidedQuestionsLength()) {
                    setTimeout(function() { activateRecipeButton(); }, 800);
                } else {
                    setTimeout(function() { showGuidedQuestion(guidedStep); }, 600);
                }
            } finally {
                isWaitingForResponse = false;
            }
        }

        /* ===== MESSAGES ===== */
        function addBotMessage(text) {
            var container = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');

            var msgDiv = document.createElement('div');
            msgDiv.className = 'message bot-message';

            var avatar = document.createElement('img');
            avatar.className = 'bot-avatar';
            avatar.src = '/granny-b-logo.png';
            avatar.alt = '';
            msgDiv.appendChild(avatar);

            var contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            var linkedContent = text
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/([a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,})/g, '<a href="mailto:$1">$1</a>')
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
            contentDiv.innerHTML = linkedContent;

            msgDiv.appendChild(contentDiv);
            container.insertBefore(msgDiv, typing);
            container.scrollTop = container.scrollHeight;
        }

        function addUserMessage(text) {
            var container = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');

            var msgDiv = document.createElement('div');
            msgDiv.className = 'message user-message';

            var contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;

            msgDiv.appendChild(contentDiv);
            container.insertBefore(msgDiv, typing);
            container.scrollTop = container.scrollHeight;
        }

        /* ===== PROMO CARDS ===== */
        var shownGroups = new Set();

        function checkPromoTriggers(text) {
            var lower = text.toLowerCase();
            var triggeredGroups = new Set();
            promoCards.forEach(function(card) {
                if (!shownPromos.has(card.id) && !triggeredGroups.has(card.group) && card.triggers.some(function(t) { return lower.includes(t); })) {
                    triggeredGroups.add(card.group);
                    // Find all cards in this group that haven't been shown yet
                    var groupCards = promoCards.filter(function(c) { return c.group === card.group && !shownPromos.has(c.id); });
                    groupCards.forEach(function(gc) {
                        shownPromos.add(gc.id);
                        if (visiblePromoEl) {
                            promoQueue.push(gc);
                        } else {
                            displayPromoCard(gc);
                        }
                    });
                }
            });
        }

        function showPromoCard(card) {
            if (!card || shownPromos.has(card.id)) return;
            shownPromos.add(card.id);
            if (visiblePromoEl) {
                promoQueue.push(card);
            } else {
                displayPromoCard(card);
            }
        }

        function showPromoGroupCards(groupName) {
            var groupCards = promoCards.filter(function(c) { return c.group === groupName && !shownPromos.has(c.id); });
            groupCards.forEach(function(gc) { showPromoCard(gc); });
        }

        function displayPromoCard(card) {
            var container = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');

            var promoDiv = document.createElement('div');
            promoDiv.className = 'promo-card';
            promoDiv.style.background = card.bg;
            promoDiv.style.borderLeftColor = card.border;

            promoDiv.innerHTML =
                '<div class="promo-actions">' +
                    '<button class="promo-check" data-card-id="' + card.id + '"></button>' +
                    '<button class="promo-dismiss">\u2715</button>' +
                '</div>' +
                '<div class="promo-badge">LEROY MERLIN</div>' +
                '<div class="promo-title">' + card.title + '</div>' +
                '<div class="promo-deal">' + card.deal + '</div>' +
                '<div class="promo-aisle">' + card.aisle + '</div>';

            promoDiv.querySelector('.promo-dismiss').onclick = function() {
                GBAnalytics.promoDismiss(card.title, card.brand);
                promoDiv.remove();
                visiblePromoEl = null;
                if (promoQueue.length > 0) {
                    setTimeout(function() { displayPromoCard(promoQueue.shift()); }, 300);
                }
            };

            var checkBtn = promoDiv.querySelector('.promo-check');
            checkBtn.onclick = function() {
                checkBtn.style.transform = 'scale(1.2)';
                setTimeout(function() { checkBtn.style.transform = 'scale(1)'; }, 100);
                if (navigator.vibrate) navigator.vibrate(50);

                if (checkBtn.classList.contains('checked')) {
                    checkBtn.classList.remove('checked');
                    checkBtn.textContent = '';
                    shoppingList = shoppingList.filter(function(item) { return item.id !== card.id; });
                    GBAnalytics.track('promo_unclick', { product: card.title, brand: card.brand || '' });
                } else {
                    checkBtn.classList.add('checked');
                    checkBtn.textContent = '\u2713';
                    shoppingList.push({ id: card.id, product: card.title, deal: card.deal, brand: card.brand, aisle: card.aisle });
                    GBAnalytics.promoClick(card.title, card.brand);
                }
            };

            visiblePromoEl = promoDiv;
            container.insertBefore(promoDiv, typing);
            container.scrollTop = container.scrollHeight;
            GBAnalytics.promoShown(card.title, card.deal, card.brand);
        }

        /* ===== SEND MESSAGE (free chat) ===== */
        async function sendMessage() {
            var input = document.getElementById('messageInput');
            var sendBtn = document.getElementById('sendButton');
            var message = input.value.trim();

            if (!message || isWaitingForResponse) return;

            isWaitingForResponse = true;
            sendBtn.disabled = true;

            addUserMessage(message);
            input.value = '';
            GBAnalytics.chatMessage('user');

            conversationHistory.push({ role: 'user', content: message });

            var typing = document.getElementById('typingIndicator');
            typing.classList.add('active');

            try {
                var response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(0, -1),
                        language: currentLanguage,
                        sku: urlParams.sku,
                        store: urlParams.store,
                        flow: flowMode
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                var data = await response.json();
                typing.classList.remove('active');

                addBotMessage(data.response);
                conversationHistory.push({ role: 'assistant', content: data.response });

                checkPromoTriggers(message);
                checkPromoTriggers(data.response);

                if (guidedStep < getGuidedQuestionsLength()) {
                    setTimeout(function() { showGuidedQuestion(guidedStep); }, 600);
                }

                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }

            } catch (error) {
                console.error('Error:', error);
                typing.classList.remove('active');
                addBotMessage('Connection error. Please try again or ask a Leroy Merlin team member for help.');
                conversationHistory.pop();
            } finally {
                isWaitingForResponse = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        /* ===== THANK YOU ===== */
        function showThankYou() {
            var s = uiStrings[currentLanguage];
            var title = leadData.name
                ? s.thanksTitleName.replace('{name}', leadData.name)
                : s.thanksTitle;
            document.getElementById('thanksTitle').textContent = title;

            var emailEl = document.getElementById('emailConfirm');
            if (leadData.email) {
                emailEl.textContent = s.emailConfirm.replace('{email}', leadData.email);
                emailEl.style.display = 'block';
            } else {
                emailEl.style.display = 'none';
            }

            document.getElementById('waplanBtnText').textContent = s.waPlanBtn;
            document.getElementById('emailShareBtnText').textContent = s.emailShareBtn;

            document.getElementById('emailShareBtn').style.display = 'flex';

            showScreen('thankYouScreen');
            fetchRecap();
        }

        async function fetchRecap() {
            if (conversationHistory.length === 0) return;

            var s = uiStrings[currentLanguage];
            var loadingEl = document.getElementById('recapLoading');
            var planBtn = document.getElementById('waplanBtn');
            loadingEl.textContent = s.recapLoading;
            loadingEl.style.display = 'block';
            planBtn.style.display = 'none';

            try {
                var response = await fetch('/recap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chatHistory: conversationHistory,
                        language: currentLanguage,
                        name: leadData.name,
                        email: leadData.email,
                        answers: consultAnswers,
                        flow: flowMode,
                        sku: urlParams.sku,
                        store: urlParams.store,
                        shoppingList: shoppingList
                    })
                });

                var data = await response.json();
                if (data.success && data.recap) {
                    recapData = data.recap;
                    loadingEl.style.display = 'none';
                    planBtn.style.display = 'flex';
                } else {
                    loadingEl.textContent = '';
                    loadingEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Recap error:', error);
                loadingEl.style.display = 'none';
            }
        }

        function formatSAPhone(phone) {
            if (!phone) return '';
            var cleaned = phone.replace(/\D/g, '');
            if (cleaned.startsWith('0') && cleaned.length === 10) {
                return '27' + cleaned.substring(1);
            }
            if (cleaned.startsWith('27') && cleaned.length === 11) {
                return cleaned;
            }
            return cleaned;
        }

        function buildWhatsAppMessage() {
            if (!recapData) return '';
            var s = uiStrings[currentLanguage];
            var r = recapData;

            var lines = [s.waHeader];

            if (r.projectType) lines.push(s.waProject + ': ' + r.projectType + (r.specificPiece ? ' - ' + r.specificPiece : ''));
            if (r.surface) lines.push(s.waSurface + ': ' + r.surface);
            if (r.dreamLook) lines.push(s.waLook + ': ' + r.dreamLook);
            if (r.recommendedColour) lines.push(s.waColour + ': ' + r.recommendedColour);
            if (r.sealer) lines.push(s.waSealer + ': ' + r.sealer);

            if (r.prepSteps) lines.push('\n' + s.waPrep + ':\n' + r.prepSteps);
            if (r.paintSteps) lines.push('\n' + s.waPaint + ':\n' + r.paintSteps);
            if (r.sealSteps) lines.push('\n' + s.waSeal + ':\n' + r.sealSteps);
            if (r.leroyProducts) lines.push('\n' + s.waLeroyProducts + ':\n' + r.leroyProducts);

            if (shoppingList.length > 0) {
                lines.push('\n\ud83d\uded2 *My Shopping List*:');
                shoppingList.forEach(function(item) {
                    lines.push('\u2022 ' + item.product + ' \u2014 ' + item.deal + ' (' + item.aisle + ')');
                });
            }

            lines.push('\n' + s.waDiscount);

            return lines.join('\n');
        }

        function sendWhatsAppPlan() {
            var message = buildWhatsAppMessage();
            if (!message) return;
            GBAnalytics.whatsappSend();

            var phone = formatSAPhone(leadData.phone);
            var encoded = encodeURIComponent(message);

            if (phone) {
                window.open('https://wa.me/' + phone + '?text=' + encoded, '_blank');
            } else {
                window.open('https://wa.me/?text=' + encoded, '_blank');
            }
        }

        function emailShareRecipe() {
            GBAnalytics.emailShare();
            var s = uiStrings[currentLanguage];
            var advisorUrl = 'https://grannybqr.summitwebcraft.co.za/?store=leroy-fourways';

            var body = s.emailShareIntro;

            if (recapData) {
                var r = recapData;
                if (r.projectType) body += s.waProject + ': ' + r.projectType + (r.specificPiece ? ' - ' + r.specificPiece : '') + '\n';
                if (r.surface) body += s.waSurface + ': ' + r.surface + '\n';
                if (r.dreamLook) body += s.waLook + ': ' + r.dreamLook + '\n';
                if (r.recommendedColour) body += s.waColour + ': ' + r.recommendedColour + '\n';
                if (r.sealer) body += s.waSealer + ': ' + r.sealer + '\n';
                if (r.prepSteps) body += '\n' + s.waPrep + ':\n' + r.prepSteps + '\n';
                if (r.paintSteps) body += '\n' + s.waPaint + ':\n' + r.paintSteps + '\n';
                if (r.sealSteps) body += '\n' + s.waSeal + ':\n' + r.sealSteps + '\n';
                if (r.leroyProducts) body += '\n' + s.waLeroyProducts + ':\n' + r.leroyProducts + '\n';

                if (shoppingList.length > 0) {
                    body += '\nMy Shopping List:\n';
                    shoppingList.forEach(function(item) {
                        body += '- ' + item.product + ' \u2014 ' + item.deal + ' (' + item.aisle + ')\n';
                    });
                }

                body += '\n' + s.waDiscount + '\n';
            }

            body += '\n' + s.emailShareTryIt + advisorUrl;

            var mailto = 'mailto:?subject=' + encodeURIComponent(s.emailShareSubject) + '&body=' + encodeURIComponent(body);
            window.location.href = mailto;
        }

        function copyCode() {
            GBAnalytics.discountCopy();
            var s = uiStrings[currentLanguage];
            if (navigator.clipboard) {
                navigator.clipboard.writeText('GRANNYB10').then(function() {
                    document.getElementById('copyHint').textContent = s.copied;
                    setTimeout(function() { document.getElementById('copyHint').textContent = s.tapToCopy; }, 2000);
                });
            } else {
                var ta = document.createElement('textarea');
                ta.value = 'GRANNYB10';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                document.getElementById('copyHint').textContent = s.copied;
                setTimeout(function() { document.getElementById('copyHint').textContent = s.tapToCopy; }, 2000);
            }
        }

        /* ===== RESET APP ===== */
        function resetApp() {
            conversationHistory = [];
            guidedStep = 0;
            shownPromos = new Set();
            promoQueue = [];
            visiblePromoEl = null;
            isWaitingForResponse = false;
            leadData = { name: '', email: '', phone: '' };
            consultAnswers = [];
            recapData = null;

            var msgs = document.getElementById('chatMessages');
            var typing = document.getElementById('typingIndicator');
            msgs.innerHTML = '';
            msgs.appendChild(typing);
            typing.classList.remove('active');

            document.getElementById('messageInput').value = '';
            document.getElementById('leadNameInput').value = '';
            document.getElementById('leadEmailInput').value = '';
            document.getElementById('leadPhoneInput').value = '';
            document.getElementById('consentCheck').checked = false;

            document.getElementById('waplanBtn').style.display = 'none';
            document.getElementById('emailShareBtn').style.display = 'none';
            document.getElementById('recapLoading').style.display = 'none';
            document.getElementById('emailConfirm').style.display = 'none';

            showScreen('leadScreen');
        }

        function applyLanguage() {
            var s = uiStrings[currentLanguage];

            document.querySelector('.done-btn').innerHTML = s.doneBtn;
            document.getElementById('messageInput').placeholder = s.inputPlaceholder;
            document.getElementById('sendButton').textContent = s.sendBtn;

            document.querySelector('.lead-header h1').textContent = s.leadTitle;
            document.querySelector('.incentive-text').textContent = s.leadIncentive;
            var labels = document.querySelectorAll('.lead-body .form-group label');
            if (labels[0]) labels[0].textContent = s.leadNameLabel;
            if (labels[1]) labels[1].textContent = s.leadEmailLabel;
            if (labels[2]) labels[2].textContent = s.leadPhoneLabel;
            document.getElementById('leadNameInput').placeholder = s.leadNamePlaceholder;
            document.getElementById('leadEmailInput').placeholder = s.leadEmailPlaceholder;
            document.getElementById('leadPhoneInput').placeholder = s.leadPhonePlaceholder;
            document.querySelector('.consent-group label').textContent = s.leadConsent;
            document.querySelector('.lead-submit-btn').innerHTML = s.leadSubmit;
            document.querySelector('.skip-link').textContent = s.leadSkip;

            document.getElementById('thanksSubtitle').textContent = s.thanksSubtitle;
            document.querySelector('.discount-note').textContent = s.discountNote;
            var ctaBtns = document.querySelectorAll('.cta-btn');
            if (ctaBtns[0]) ctaBtns[0].innerHTML = s.ctaShop;
            if (ctaBtns[1]) ctaBtns[1].textContent = s.ctaRewards;
            document.getElementById('copyHint').textContent = s.tapToCopy;
            document.getElementById('waplanBtnText').textContent = s.waPlanBtn;
            document.getElementById('emailShareBtnText').textContent = s.emailShareBtn;
            if (leadData.email) {
                document.getElementById('emailConfirm').textContent = s.emailConfirm.replace('{email}', leadData.email);
            }
        }

        /* ===== VOICE: SPEECH RECOGNITION ===== */
        function getSupportedMimeType() {
            var types = ['audio/mp4', 'audio/webm;codecs=opus', 'audio/webm', 'audio/ogg'];
            for (var i = 0; i < types.length; i++) {
                if (MediaRecorder.isTypeSupported(types[i])) return types[i];
            }
            return 'audio/mp4';
        }

        function initSpeechRecognition() {
            var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            if (!isIOS && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;

                recognition.onstart = function() {
                    isRecording = true;
                    document.getElementById('micBtn').classList.add('recording');
                    document.getElementById('voiceStatus').classList.add('active');
                    document.getElementById('voiceStatus').textContent = '\uD83C\uDFA4 Listening...';
                };

                recognition.onend = function() {
                    isRecording = false;
                    document.getElementById('micBtn').classList.remove('recording');
                    document.getElementById('voiceStatus').classList.remove('active');
                };

                recognition.onresult = function(event) {
                    var finalTranscript = '';
                    for (var i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    if (finalTranscript) {
                        document.getElementById('messageInput').value = finalTranscript;
                        sendMessage();
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isRecording = false;
                    document.getElementById('micBtn').classList.remove('recording');
                    document.getElementById('voiceStatus').classList.remove('active');
                };
            }
        }

        async function toggleVoiceInput() {
            if (recognition) {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.lang = speechLanguageMap[currentLanguage];
                    try { recognition.start(); }
                    catch (e) { await startWhisperRecording(); }
                }
                return;
            }
            if (isRecording) { stopWhisperRecording(); }
            else { await startWhisperRecording(); }
        }

        async function startWhisperRecording() {
            try {
                var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                var options = {};

                if (!isIOS) {
                    var mimeType = getSupportedMimeType();
                    if (mimeType) options = { mimeType: mimeType };
                }

                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async function() {
                    document.getElementById('micBtn').classList.remove('recording');
                    document.getElementById('voiceStatus').textContent = '\u23F3 Processing...';
                    stream.getTracks().forEach(function(track) { track.stop(); });

                    var recordedMimeType = mediaRecorder.mimeType || 'audio/mp4';
                    var audioBlob = new Blob(audioChunks, { type: recordedMimeType });

                    if (audioChunks.length === 0 || audioBlob.size < 100) {
                        alert('Recording failed. Please speak for at least 2 seconds and try again.');
                        document.getElementById('voiceStatus').classList.remove('active');
                        return;
                    }
                    await sendAudioToSTT(audioBlob, recordedMimeType);
                };

                mediaRecorder.start(500);
                window.recordingStartTime = Date.now();
                mediaRecorder.onerror = function(e) { alert('MediaRecorder ERROR: ' + e.error.name); };

                isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                document.getElementById('voiceStatus').classList.add('active');
                document.getElementById('voiceStatus').textContent = '\uD83C\uDFA4 Listening...';

            } catch (err) {
                console.error('Microphone error:', err);
                alert('Microphone error: ' + err.message);
            }
        }

        function stopWhisperRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
            }
        }

        async function sendAudioToSTT(audioBlob, mimeType) {
            try {
                var filename = 'recording.mp4';
                if (mimeType) {
                    if (mimeType.includes('webm')) filename = 'recording.webm';
                    else if (mimeType.includes('ogg')) filename = 'recording.ogg';
                    else if (mimeType.includes('wav')) filename = 'recording.wav';
                }

                var formData = new FormData();
                formData.append('audio_file', audioBlob, filename);

                var response;
                try {
                    response = await fetch('/stt', { method: 'POST', body: formData });
                } catch (fetchError) {
                    alert('Network error: ' + fetchError.message);
                    document.getElementById('voiceStatus').classList.remove('active');
                    return;
                }

                if (!response.ok) {
                    var errorText = await response.text();
                    alert('Server error ' + response.status + ': ' + errorText);
                    document.getElementById('voiceStatus').classList.remove('active');
                    return;
                }

                var data = await response.json();
                document.getElementById('voiceStatus').classList.remove('active');

                if (data.text && data.text.trim()) {
                    document.getElementById('messageInput').value = data.text;
                    sendMessage();
                } else if (data.error) {
                    alert('Voice error: ' + data.error);
                } else {
                    alert('No speech detected. Please try again.');
                }

            } catch (error) {
                console.error('STT Error:', error);
                document.getElementById('voiceStatus').classList.remove('active');
                alert('Voice processing failed: ' + error.message);
            }
        }

        /* ===== FLOATING MASCOT PAINT TIPS ===== */
        const paintTips = {
            en: [
                "Did you know? Granny B's chalk paint needs zero sanding or prepping before use!",
                "Quick tip: Granny B's chalk paint dries touch-dry in just 30 minutes.",
                "Pro tip: Use Armour Sealer on kitchen cabinets and high-traffic furniture for lasting protection.",
                "Fun fact: Granny B's chalk paint works on glass, metal, wood, ceramic, melamine, and even fabric!",
                "Try this: Apply Dark Wax over a lighter chalk paint colour for an instant vintage distressed look.",
                "Colour tip: Not sure about a colour? Try a 125ml jar from R79.90 before committing to a full litre!",
                "Good to know: 1 litre of chalk paint covers approximately 12-14 square metres.",
                "Save money: Granny B's offers free delivery on orders over R650 at grannyb.co.za!"
            ]
        };
        let lastTipIndex = -1;

        function triggerPaintTip() {
            if (document.getElementById('chatScreen').style.display !== 'flex') return;
            if (isWaitingForResponse) return;

            var tips = paintTips.en;
            var index;
            do {
                index = Math.floor(Math.random() * tips.length);
            } while (index === lastTipIndex && tips.length > 1);
            lastTipIndex = index;

            addBotMessage(tips[index]);
        }

        /* ===== KEYBOARD ===== */
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && document.activeElement === document.getElementById('messageInput')) {
                e.preventDefault();
                sendMessage();
            }
        });

        /* ===== ANALYTICS TRACKING ===== */
        const GBAnalytics = {
            sessionId: 'ss_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            clientId: new URLSearchParams(window.location.search).get('client') || 'direct',
            store: new URLSearchParams(window.location.search).get('store') || 'leroy-merlin',
            promoTimers: {},

            track(eventType, eventData) {
                var payload = {
                    sessionId: this.sessionId,
                    store: this.store,
                    event_type: eventType,
                    event_data: eventData || {},
                    client: this.clientId,
                    timestamp: new Date().toISOString()
                };
                fetch('/analytics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).catch(function() {});
            },

            scan() { this.track('scan', { sku: urlParams.sku, flow: flowMode }); },
            leadSubmit(name, email) { this.track('lead_submit', { name: name, email: email }); },
            guidedAnswer(question, answer) { this.track('guided_answer', { question: question, answer: answer }); },
            promoShown(product, price, brand) {
                this.promoTimers[product] = Date.now();
                this.track('promo_shown', { product: product, price: price, brand: brand || '' });
            },
            promoClick(product, brand) { this.track('promo_click', { product: product, brand: brand || '' }); },
            promoDismiss(product, brand) {
                var duration = this.promoTimers[product] ? Date.now() - this.promoTimers[product] : 0;
                this.track('promo_dismiss', { product: product, brand: brand || '', viewDuration: duration });
            },
            chatMessage(role) { this.track('chat_message', { role: role }); },
            recipeTap() { this.track('recipe_tap', {}); },
            whatsappSend() { this.track('whatsapp_send', {}); },
            emailShare() { this.track('email_share', {}); },
            discountCopy() { this.track('discount_copy', {}); }
        };

        /* ===== INIT ===== */
        parseUrlParams();
        initSpeechRecognition();
        GBAnalytics.scan();
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js'); }
    </script>
</body>
</html>
